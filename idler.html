<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lazy Island</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üèùÔ∏è</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #87CEEB 0%, #98D8C8 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            overflow: hidden;
        }

        .game-container {
            background: 
                repeating-linear-gradient(
                    45deg,
                    rgba(139, 195, 74, 0.1) 0px,
                    rgba(139, 195, 74, 0.1) 10px,
                    transparent 10px,
                    transparent 20px
                ),
                repeating-linear-gradient(
                    -45deg,
                    rgba(104, 159, 56, 0.1) 0px,
                    rgba(104, 159, 56, 0.1) 10px,
                    transparent 10px,
                    transparent 20px
                ),
                linear-gradient(135deg, #A5D6A7 0%, #81C784 50%, #66BB6A 100%);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 1248px;
            height: 948px;
            padding: 24px;
            display: grid;
            grid-template-columns: repeat(12, 100px);
            grid-template-rows: repeat(9, 100px);
            gap: 0;
            overflow: hidden;
            position: relative;
        }
        
        .game-container.show-grid::after {
            content: '';
            position: absolute;
            top: 24px;
            left: 24px;
            width: 1200px;
            height: 900px;
            background-image: 
                repeating-linear-gradient(
                    to right,
                    rgba(0, 0, 0, 0.3) 0px,
                    rgba(0, 0, 0, 0.3) 2px,
                    transparent 2px,
                    transparent 100px
                ),
                repeating-linear-gradient(
                    to bottom,
                    rgba(0, 0, 0, 0.3) 0px,
                    rgba(0, 0, 0, 0.3) 2px,
                    transparent 2px,
                    transparent 100px
                ),
                linear-gradient(
                    to right,
                    transparent calc(100% - 2px),
                    rgba(0, 0, 0, 0.3) calc(100% - 2px)
                ),
                linear-gradient(
                    to bottom,
                    transparent calc(100% - 2px),
                    rgba(0, 0, 0, 0.3) calc(100% - 2px)
                );
            background-size: 100px 100px, 100px 100px, 100% 100%, 100% 100%;
            background-position: 0 0, 0 0, 0 0, 0 0;
            pointer-events: none;
            z-index: 1;
        }

        .top-section {
            grid-column: 1 / -1;
            grid-row: 1 / 2;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .right-sidebar {
            grid-column: 10 / -1;
            grid-row: 2 / -1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 240px;
            max-width: 240px;
        }

        .middle-section {
            display: contents;
        }

        .grid-container {
            position: relative;
            overflow: hidden;
        }

        .grid-container.draggable {
            cursor: move;
            transition: none;
        }

        .dragging {
            opacity: 0 !important;
            pointer-events: none;
        }

        .grid-snap-preview {
            position: absolute;
            border: 3px dashed #2196F3;
            background: rgba(33, 150, 243, 0.2);
            pointer-events: none;
            z-index: 999;
            border-radius: 8px;
        }

        .shop-section-wrapper {
            grid-column: 5 / span 3;
            grid-row: 2 / span 3;
            position: relative;
            z-index: 2;
            border: 3px solid #FFB3BA;
            background: linear-gradient(135deg, #FFF9E6 0%, #FFE8B3 100%);
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .shop-section-wrapper::before {
            content: '3√ó3';
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: bold;
            display: none;
            z-index: 10;
        }

        .game-container.show-grid .shop-section-wrapper::before {
            display: block;
        }

        .shop-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin-bottom: 6px;
        }

        .shop-header h2 {
            margin: 0;
            white-space: nowrap;
            font-size: 0.95em;
        }

        .shop-upgrade-btn {
            background: linear-gradient(135deg, #6BAA5E 0%, #5A9A4D 100%);
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(107, 170, 94, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
            white-space: nowrap;
        }

        .shop-upgrade-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(107, 170, 94, 0.4);
        }

        .shop-upgrade-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
        }

        .shop-upgrade-btn:disabled:hover {
            transform: none;
            box-shadow: 0 2px 8px rgba(107, 170, 94, 0.3);
        }

        .main-header {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFE8B3 100%);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 2;
            min-width: 300px;
        }


        h1 {
            color: #F7B32B;
            font-size: 1.8em;
            margin-bottom: 8px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .stats {
            text-align: center;
            margin-bottom: 0;
        }

        .bell-count {
            font-size: 1.6em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .per-second {
            font-size: 0.85em;
            color: #666;
        }

        .total-production {
            font-size: 0.8em;
            color: #6BAA5E;
            margin-top: 5px;
            font-weight: 600;
        }

        .fish-message {
            display: none;
        }

        .fish-message strong {
            color: #0D47A1;
            font-size: 1em;
        }

        .fish-message .fish-details {
            margin-top: 5px;
            font-size: 0.85em;
            color: #1976D2;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h2 {
            color: #6BAA5E;
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .shop-items {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 8px;
            max-height: 220px;
            overflow-y: auto;
        }

        .shop-items.closed {
            display: none;
        }

        .shop-closed-message {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-size: 1.1em;
            font-style: italic;
        }

        .shop-item {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFE8CC 100%);
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid #F7B32B;
        }

        .shop-item-disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .shop-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3px;
        }

        .shop-item-name {
            font-size: 0.85em;
            font-weight: bold;
            color: #333;
        }

        .shop-item-price {
            font-size: 0.9em;
            font-weight: bold;
            color: #F7B32B;
        }

        .shop-item-description {
            font-size: 0.75em;
            color: #666;
            margin-bottom: 3px;
        }

        .shop-item-owned {
            font-size: 0.7em;
            color: #6BAA5E;
            font-weight: bold;
        }

        .bell-clicker-button {
            background: transparent;
            border: none;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.1s;
            user-select: none;
            margin: 10px auto 0;
            width: 80px;
            height: 80px;
            position: relative;
        }

        .bell-clicker-button:hover {
            transform: scale(1.1);
        }

        .bell-clicker-button:active {
            transform: scale(0.9);
        }

        .bell-icon {
            font-size: 2.5em;
            animation: bellBounce 2s ease-in-out infinite;
        }

        @keyframes bellBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .bell-click-text {
            position: absolute;
            font-size: 1.5em;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            z-index: 1000;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px);
            }
        }

        .island-activities-section {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFEAA7 100%);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            grid-column: 1 / span 4;
            grid-row: 2 / span 5;
            overflow: auto;
            position: relative;
            z-index: 2;
            border: 3px solid #FFDFBA;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }

        .island-activities-section::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        .island-activities-section::before {
            content: '4√ó5';
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: bold;
            display: none;
            z-index: 10;
        }

        .game-container.show-grid .island-activities-section::before {
            display: block;
        }

        .island-activities-header {
            text-align: center;
            margin-bottom: 8px;
        }

        .island-activities-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #F7B32B;
            margin-bottom: 3px;
        }

        .upgrades-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            max-height: 530px;
            padding-right: 5px;
        }

        .upgrades-container::-webkit-scrollbar {
            width: 8px;
        }

        .upgrades-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .upgrades-container::-webkit-scrollbar-thumb {
            background: #6BAA5E;
            border-radius: 10px;
        }

        .upgrade-item {
            background: linear-gradient(135deg, #FFF8DC 0%, #E8F5E9 100%);
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .upgrade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .upgrade-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .upgrade-info {
            flex: 1;
        }

        .upgrade-name {
            font-size: 0.95em;
            font-weight: bold;
            color: #333;
            margin-bottom: 2px;
        }

        .upgrade-description {
            font-size: 0.75em;
            color: #666;
            margin-bottom: 2px;
        }

        .upgrade-owned {
            font-size: 0.7em;
            color: #6BAA5E;
            font-weight: bold;
        }

        .progress-bar-container {
            width: 100%;
            height: 18px;
            background: rgba(107, 170, 94, 0.2);
            border-radius: 9px;
            overflow: hidden;
            position: relative;
            margin-top: 5px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #6BAA5E 0%, #8BC34A 100%);
            border-radius: 12px;
            transition: width 0.1s linear;
            position: relative;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.85em;
            font-weight: bold;
            color: #333;
            text-shadow: 0 0 3px white;
            z-index: 1;
        }

        .production-rate {
            font-size: 0.85em;
            color: #F7B32B;
            font-weight: bold;
            margin-top: 3px;
        }

        .fishing-areas {
            margin-top: 8px;
            padding: 10px;
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border-radius: 8px;
            border: 2px solid #6BAA5E;
            border: 3px solid #2196F3;
        }

        .fishing-areas-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .fishing-areas-title {
            font-size: 0.95em;
            font-weight: bold;
            color: #2E7D32;
        }

        .fishing-catch-message {
            font-size: 0.85em;
            font-weight: bold;
            color: #2E7D32;
            text-align: right;
            min-height: 1.2em;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .fishing-area {
            background: white;
            padding: 8px;
            margin-bottom: 6px;
            border-radius: 6px;
            border: 2px solid #E8F5E9;
            display: flex;
            flex-direction: column;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .fishing-area:hover {
            border-color: #6BAA5E;
            transform: translateX(2px);
        }

        .fishing-area.active {
            border-color: #2196F3;
            background: #E3F2FD;
        }

        .fishing-area-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .fishing-area:last-child {
            margin-bottom: 0;
        }

        .area-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .area-text {
            min-width: 150px;
        }

        .area-name {
            font-weight: bold;
            color: #333;
            font-size: 0.9em;
            margin-bottom: 2px;
        }

        .area-fish-types {
            font-size: 0.75em;
            color: #666;
        }

        .area-progress-container {
            width: 100%;
            height: 8px;
            background: rgba(33, 150, 243, 0.15);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            margin-top: 6px;
            display: none;
        }

        .fishing-area.active .area-progress-container {
            display: block;
        }

        .area-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #2196F3 0%, #64B5F6 100%);
            border-radius: 4px;
            transition: width 0.1s linear;
            position: relative;
        }

        .area-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.75em;
            font-weight: bold;
            color: #333;
            text-shadow: 0 0 3px white;
        }

        .fishing-areas-instruction {
            font-size: 0.85em;
            text-align: center;
            margin-bottom: 8px;
            font-style: italic;
            font-weight: bold;
            background: linear-gradient(90deg, 
                #ff0000, #ff7f00, #ffff00, #00ff00, 
                #0000ff, #4b0082, #9400d3, #ff0000);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: rainbow 3s linear infinite;
        }

        @keyframes rainbow {
            0% {
                background-position: 0% 50%;
            }
            100% {
                background-position: 200% 50%;
            }
        }

        .rod-count {
            font-size: 1em;
            font-weight: bold;
            color: #2196F3;
            min-width: 25px;
            text-align: center;
        }

        .area-button {
            background: #6BAA5E;
            color: white;
            border: none;
            border-radius: 5px;
            width: 26px;
            height: 26px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: background 0.2s;
        }

        .area-button:hover:not(:disabled) {
            background: #5A9A4E;
        }

        .area-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .unassigned-rods {
            font-size: 0.85em;
            color: #F7B32B;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .upgrade-cost {
            font-size: 1.3em;
            font-weight: bold;
            color: #F7B32B;
            white-space: nowrap;
            margin-left: 15px;
        }

        .reset-button {
            position: fixed;
            top: 20px;
            right: 110px;
            background: linear-gradient(135deg, #E57373 0%, #EF5350 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(229, 115, 115, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
            z-index: 1000;
            border: 3px solid #FFC107;
        }

        .reset-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(229, 115, 115, 0.4);
        }

        .reset-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(229, 115, 115, 0.3);
        }

        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #6BAA5E 0%, #5A9A4D 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.2em;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(107, 170, 94, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
            z-index: 1000;
            border: 3px solid #8BC34A;
        }

        .dark-mode-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(107, 170, 94, 0.4);
        }

        .dark-mode-toggle:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(107, 170, 94, 0.3);
        }

        .lock-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #FFA726 0%, #FB8C00 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 167, 38, 0.3);
            transition: all 0.3s;
            z-index: 1000;
            border: 3px solid #FF9800;
        }

        .lock-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 167, 38, 0.4);
        }

        .lock-toggle:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(255, 167, 38, 0.3);
        }

        .lock-toggle.locked {
            background: linear-gradient(135deg, #66BB6A 0%, #43A047 100%);
        }

        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        body.dark-mode .game-container {
            background: #0f3460;
            color: #e8e8e8;
        }

        body.dark-mode .main-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }

        body.dark-mode .header {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            border-color: #5A9A4D;
        }

        body.dark-mode h1 {
            color: #F7B32B;
        }

        body.dark-mode .bell-count {
            color: #ffffff;
        }

        body.dark-mode .per-second {
            color: #d0d0d0;
        }

        body.dark-mode .shop-item {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-color: #F7B32B;
        }

        body.dark-mode .shop-item-name {
            color: #ffffff;
        }

        body.dark-mode .shop-item-description {
            color: #d0d0d0;
        }

        body.dark-mode .upgrade-item {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }

        body.dark-mode .upgrade-name {
            color: #ffffff;
        }

        body.dark-mode .upgrade-description {
            color: #d0d0d0;
        }

        body.dark-mode .calendar-section {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }

        body.dark-mode .calendar-date {
            color: #a5d6a7;
        }

        body.dark-mode .calendar-day {
            color: #81C784;
        }

        body.dark-mode .seasonal-fish-title {
            color: #a5d6a7;
        }

        body.dark-mode .fish-location-name {
            color: #a5d6a7;
        }

        body.dark-mode .fish-tag {
            background: #1a1a2e;
            color: #a5d6a7;
            border-color: #5A9A4D;
        }

        body.dark-mode .fish-tag:hover {
            background: #2c3e50;
        }

        body.dark-mode .fish-tooltip {
            background: #2c3e50;
            border-color: #5A9A4D;
        }

        body.dark-mode .fish-tooltip-name {
            color: #a5d6a7;
            border-color: #5A9A4D;
        }

        body.dark-mode .fish-tooltip-label {
            color: #a5d6a7;
        }

        body.dark-mode .fish-tooltip-value {
            color: #ffffff;
        }

        body.dark-mode .game-container {
            background: 
                radial-gradient(
                    circle at 20% 30%,
                    rgba(46, 125, 50, 0.1) 0%,
                    transparent 50%
                ),
                radial-gradient(
                    circle at 80% 70%,
                    rgba(56, 142, 60, 0.08) 0%,
                    transparent 50%
                ),
                linear-gradient(135deg, #1a2f26 0%, #0f1f18 50%, #0a150f 100%);
        }

        body.dark-mode .shop-section-wrapper {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }

        body.dark-mode .island-activities-section {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }

        body.dark-mode .villagers-section {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }

        body.dark-mode .villager-slot {
            background: #1a1a2e;
            border-color: #F7B32B;
        }

        body.dark-mode .villager-slot.buy-house {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-color: #5A9A4D;
        }

        body.dark-mode .villager-tooltip {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-color: #F7B32B;
        }

        body.dark-mode .villager-tooltip-name {
            color: #FFD54F;
        }

        body.dark-mode .villager-tooltip-info {
            color: #ffffff;
        }

        body.dark-mode .villager-tooltip-label {
            color: #a5d6a7;
        }

        body.dark-mode .museum-section {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }

        body.dark-mode .museum-title {
            color: #FFD54F;
        }

        body.dark-mode .museum-stats {
            color: #ffffff;
        }

        body.dark-mode .museum-progress-text {
            color: #ffffff;
        }

        body.dark-mode .museum-fish-item {
            background: #1a1a2e;
            border-color: #34495e;
            color: #ffffff;
        }

        body.dark-mode .museum-fish-name {
            color: #ffffff;
        }

        body.dark-mode .museum-reward {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #FFD54F;
            border-color: #FFD54F;
        }

        body.dark-mode .villager-points-section {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }

        body.dark-mode .villager-points-title {
            color: #a5d6a7;
        }

        body.dark-mode .villager-points-info {
            color: #ffffff;
        }

        body.dark-mode .activity-point-item {
            background: #1a1a2e;
            border-color: #5A9A4D;
        }

        body.dark-mode .activity-point-name {
            color: #ffffff;
        }

        body.dark-mode .fishing-areas {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-color: #5A9A4D;
        }

        body.dark-mode .fishing-area {
            background: #1a1a2e;
            border-color: #34495e;
        }

        body.dark-mode .fishing-areas-title {
            color: #a5d6a7;
        }

        body.dark-mode .area-name {
            color: #ffffff;
        }

        body.dark-mode .area-fish-types {
            color: #d0d0d0;
        }

        body.dark-mode .fishing-catch-message {
            color: #a5d6a7;
        }

        body.dark-mode .villager-selection-content,
        body.dark-mode .villager-assignment-content {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }

        body.dark-mode .villager-choice,
        body.dark-mode .villager-assignment-item {
            background: #1a1a2e;
            border-color: #F7B32B;
        }

        body.dark-mode .villager-choice-name {
            color: #ffffff;
        }

        body.dark-mode .villager-choice-info {
            color: #d0d0d0;
        }

        .main-layout {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: flex-start;
        }

        .left-column {
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 270px;
        }

        .right-column {
            flex: 1;
            min-width: 0;
        }

        .calendar-museum-column {
            display: contents;
        }

        .header {
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 2;
            grid-column: 5 / span 2;
            grid-row: 1 / span 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            border: 3px solid #FFFFBA;
        }

        .header::before {
            content: '2√ó1';
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: bold;
            display: none;
            z-index: 10;
        }

        .game-container.show-grid .header::before {
            display: block;
        }

        .header h1 {
            margin: 0;
            font-size: 1.2em;
            line-height: 1.2;
        }

        .header .bell-count {
            margin: 3px 0;
            font-size: 1em;
        }

        .header .per-second {
            margin: 0;
            font-size: 0.85em;
        }

        .calendar-section {
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            grid-column: 9 / span 3;
            grid-row: 1 / span 4;
            overflow: auto;
            position: relative;
            z-index: 2;
            border: 3px solid #BAFFC9;
        }

        .calendar-section::before {
            content: '3√ó4';
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: bold;
            display: none;
            z-index: 10;
        }

        .game-container.show-grid .calendar-section::before {
            display: block;
        }

        .calendar-header {
            text-align: center;
            margin-bottom: 2px;
        }

        .calendar-date {
            font-size: 0.95em;
            font-weight: bold;
            color: #2E7D32;
            margin-bottom: 0;
        }

        .calendar-day {
            font-size: 0.7em;
            color: #558B2F;
        }

        .seasonal-fish {
            margin-top: 2px;
        }

        .seasonal-fish-title {
            font-size: 0.75em;
            font-weight: bold;
            color: #2E7D32;
            margin-bottom: 2px;
            text-align: center;
            border-bottom: 1px solid #81C784;
            padding-bottom: 1px;
        }

        .fish-location-group {
            margin-bottom: 2px;
        }

        .fish-location-name {
            font-size: 0.7em;
            font-weight: bold;
            color: #388E3C;
            margin-bottom: 1px;
        }

        .fish-list {
            display: flex;
            flex-wrap: wrap;
            gap: 1px;
        }

        .fish-tag {
            background: white;
            padding: 1px 4px;
            border-radius: 6px;
            font-size: 0.6em;
            color: #2E7D32;
            border: 1px solid #A5D6A7;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .fish-tag:hover {
            background: #E8F5E9;
            border-color: #66BB6A;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 10;
        }

        .fish-tooltip {
            position: fixed;
            background: white;
            border: 2px solid #66BB6A;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            min-width: 250px;
            pointer-events: none;
            display: none;
        }

        .fish-tooltip-content {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .fish-tooltip-image {
            width: 75px;
            height: 75px;
            object-fit: contain;
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            border-radius: 8px;
            flex-shrink: 0;
        }

        .fish-tooltip-image-placeholder {
            width: 75px;
            height: 75px;
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            flex-shrink: 0;
        }

        .fish-tooltip-details {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .fish-tooltip.show {
            display: block;
        }

        .fish-tooltip-name {
            font-size: 0.95em;
            font-weight: bold;
            color: #2E7D32;
            margin-bottom: 6px;
            border-bottom: 1px solid #A5D6A7;
            padding-bottom: 3px;
        }

        .fish-tooltip-info {
            font-size: 0.8em;
            color: #555;
            line-height: 1.5;
        }

        .fish-tooltip-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }

        .fish-tooltip-label {
            font-weight: bold;
            color: #388E3C;
        }

        .fish-tooltip-value {
            color: #666;
        }

        .no-fish {
            font-size: 0.7em;
            color: #757575;
            font-style: italic;
            text-align: center;
            padding: 2px;
        }

        .villagers-section {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            grid-column: 3 / span 6;
            grid-row: 7 / span 3;
            overflow: visible;
            position: relative;
            z-index: 2;
            border: 3px solid #BAFFC9;
        }

        .villagers-section::before {
            content: '6√ó3';
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: bold;
            display: none;
            z-index: 10;
        }

        .game-container.show-grid .villagers-section::before {
            display: block;
        }

        .villagers-section.visible {
            display: grid;
        }

        .villagers-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .villagers-title {
            font-size: 1em;
            font-weight: bold;
            color: #F7B32B;
        }

        .buy-house-button {
            background: linear-gradient(135deg, #6BAA5E 0%, #5A9A4D 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        .buy-house-button:hover {
            transform: scale(1.05);
        }

        .buy-house-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .villagers-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 8px;
        }

        .villager-slot {
            width: 100px;
            height: 100px;
            background: white;
            border: 2px solid #F7B32B;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 1;
        }
        
        .villager-slot:not(.empty):hover {
            transform: scale(1.05);
            z-index: 10001;
        }

        .villager-slot.empty {
            background: rgba(255, 255, 255, 0.3);
            border-style: dashed;
        }
        
        .villager-slot.buy-house {
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border: 2px solid #6BAA5E;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .villager-slot.buy-house:hover {
            transform: scale(1.05);
        }
        
        .buy-house-icon {
            font-size: 2.5em;
            color: #6BAA5E;
        }
        
        .buy-house-price {
            font-size: 0.75em;
            font-weight: bold;
            color: #6BAA5E;
            text-align: center;
        }

        .villager-portrait {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        .villager-placeholder {
            font-size: 2em;
            color: #F7B32B;
        }

        .villager-tooltip {
            position: absolute;
            bottom: 110px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #FFF9E6 0%, #FFE8B3 100%);
            color: #333;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.85em;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 2px solid #F7B32B;
            min-width: 140px;
        }

        .villager-slot:hover .villager-tooltip {
            opacity: 1;
        }

        .villager-tooltip-name {
            font-weight: bold;
            color: #F7B32B;
            margin-bottom: 6px;
            font-size: 1.1em;
            text-align: center;
        }

        .villager-tooltip-info {
            font-size: 0.9em;
            color: #666;
            line-height: 1.6;
        }

        .villager-tooltip-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }

        .villager-tooltip-label {
            font-weight: bold;
            color: #6BAA5E;
            margin-right: 8px;
        }


        .museum-section {
            background: linear-gradient(135deg, #E8EAF6 0%, #C5CAE9 100%);
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            grid-column: 9 / span 3;
            grid-row: 6 / span 4;
            overflow: auto;
            position: relative;
            z-index: 2;
            border: 3px solid #BAE1FF;
        }

        .museum-section::before {
            content: '3√ó4';
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: bold;
            display: none;
            z-index: 10;
        }

        .game-container.show-grid .museum-section::before {
            display: block;
        }

        .museum-header {
            text-align: center;
            margin-bottom: 6px;
        }

        .museum-title {
            font-size: 1em;
            font-weight: bold;
            color: #3F51B5;
            margin-bottom: 2px;
        }

        .museum-stats {
            font-size: 0.75em;
            color: #5C6BC0;
            margin-bottom: 6px;
        }

        .museum-progress {
            width: 100%;
            height: 16px;
            background: rgba(63, 81, 181, 0.2);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            margin-bottom: 8px;
        }

        .museum-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3F51B5 0%, #5C6BC0 100%);
            border-radius: 8px;
            transition: width 0.3s ease;
        }

        .museum-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.75em;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 3px rgba(0,0,0,0.5);
        }

        .museum-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 6px;
        }

        .museum-tab {
            flex: 1;
            padding: 6px;
            background: #E8F5E9;
            border: 2px solid #BAE1FF;
            border-radius: 6px;
            text-align: center;
            font-size: 0.85em;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }

        .museum-tab:hover {
            background: #C8E6C9;
        }

        .museum-tab.active {
            background: #3F51B5;
            color: white;
            border-color: #3F51B5;
        }

        .museum-title {
            font-size: 1em;
            font-weight: bold;
            color: #3F51B5;
            margin-bottom: 2px;
        }

        .museum-stats {
            font-size: 0.75em;
            color: #5C6BC0;
            margin-bottom: 6px;
        }

        .museum-fish-list {
            max-height: 200px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .museum-fish-list::-webkit-scrollbar {
            width: 4px;
        }

        .museum-fish-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .museum-fish-list::-webkit-scrollbar-thumb {
            background: #3F51B5;
            border-radius: 10px;
        }

        .museum-fish-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 6px;
            margin-bottom: 3px;
            background: white;
            border-radius: 6px;
            font-size: 0.7em;
            border: 1px solid #C5CAE9;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }

        .museum-fish-item:hover {
            background: #F5F5F5;
        }

        .villager-points-section {
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border-radius: 12px;
            padding: 12px;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .villager-points-title {
            font-size: 1em;
            font-weight: bold;
            color: #6BAA5E;
            margin-bottom: 8px;
        }

        .villager-points-info {
            font-size: 0.8em;
            color: #555;
            margin-bottom: 10px;
        }

        .activity-point-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 6px;
            background: white;
            border-radius: 6px;
            border: 2px solid #E8F5E9;
        }

        .activity-point-name {
            font-weight: bold;
            color: #333;
            flex: 1;
        }

        .activity-point-bonus {
            font-size: 0.85em;
            color: #6BAA5E;
            margin: 0 10px;
        }

        .activity-point-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .point-button {
            background: linear-gradient(135deg, #6BAA5E 0%, #5A9A4D 100%);
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .point-button:hover:not(:disabled) {
            transform: scale(1.1);
        }

        .point-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .activity-point-count {
            font-weight: bold;
            color: #6BAA5E;
            min-width: 20px;
            text-align: center;
        }

        .museum-fish-item.donated {
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border-color: #81C784;
        }

        .museum-fish-item.not-caught {
            opacity: 0.4;
        }

        .museum-fish-name {
            flex: 1;
            color: #333;
        }

        .museum-fish-status {
            font-size: 0.9em;
            margin-left: 4px;
        }

        .donate-button {
            background: #3F51B5;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85em;
            cursor: pointer;
            transition: background 0.2s;
        }

        .donate-button:hover {
            background: #303F9F;
        }

        .donate-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .museum-reward {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFE8B3 100%);
            border: 2px solid #F7B32B;
            border-radius: 6px;
            padding: 6px;
            margin-top: 6px;
            text-align: center;
            font-size: 0.75em;
            color: #F7B32B;
            font-weight: bold;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            gap: 20px;
            pointer-events: none;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-spinner {
            font-size: 4em;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 1.5em;
            color: #F7B32B;
            font-weight: bold;
        }
        
        .loading-status {
            font-size: 1em;
            color: #666;
        }
        
        .villager-selection-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .villager-selection-modal.active {
            display: flex;
        }
        
        .villager-selection-content {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFE8B3 100%);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
        }
        
        .villager-selection-title {
            font-size: 1.8em;
            color: #F7B32B;
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .villager-choices {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .villager-choice {
            background: white;
            border: 3px solid #F7B32B;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            flex: 1;
            max-width: 150px;
            position: relative;
        }

        .villager-rarity-stars {
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: 14px;
            line-height: 1;
        }

        .villager-rarity-stars .star {
            color: #FFD700;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.3);
        }
        
        .villager-choice:hover {
            transform: scale(1.05);
            border-color: #6BAA5E;
            box-shadow: 0 4px 12px rgba(107, 170, 94, 0.3);
        }
        
        .villager-choice-portrait {
            width: 100px;
            height: 100px;
            object-fit: contain;
            margin-bottom: 10px;
        }
        
        .villager-choice-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .villager-choice-info {
            font-size: 0.85em;
            color: #666;
        }
        
        .assigned-villagers {
            margin-top: 10px;
            padding: 8px;
            background: rgba(255, 249, 230, 0.5);
            border-radius: 6px;
            font-size: 0.85em;
        }
        
        .assigned-villager-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px;
            margin: 4px 0;
            background: white;
            border-radius: 4px;
        }
        
        .assigned-villager-portrait {
            width: 30px;
            height: 30px;
            object-fit: contain;
            border-radius: 4px;
        }
        
        .assigned-villager-name {
            flex: 1;
            font-weight: bold;
            color: #333;
        }
        
        .unassign-button {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .unassign-button:hover {
            background: #ff5252;
        }
        
        .assign-button {
            background: #6BAA5E;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 8px;
            width: 100%;
        }
        
        .assign-button:hover {
            background: #5a9950;
        }
        
        .assign-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .villager-assignment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .villager-assignment-modal.active {
            display: flex;
        }
        
        .villager-assignment-content {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFE8B3 100%);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .villager-assignment-title {
            font-size: 1.5em;
            color: #F7B32B;
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .villager-assignment-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .villager-assignment-item {
            background: white;
            border: 3px solid #F7B32B;
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .villager-assignment-item:hover {
            transform: scale(1.05);
            border-color: #6BAA5E;
            box-shadow: 0 4px 12px rgba(107, 170, 94, 0.3);
        }
        
        .villager-assignment-item.assigned {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .villager-assignment-item.assigned:hover {
            transform: none;
            border-color: #F7B32B;
            box-shadow: none;
        }
        
        .assignment-cancel {
            background: #999;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            width: 100%;
        }
        
        .assignment-cancel:hover {
            background: #777;
        }

        @media (max-width: 768px) {
            .game-container {
                padding: 10px;
                max-width: 100%;
            }

            h1 {
                font-size: 1.4em;
                margin-bottom: 10px;
            }

            /* Layout adjustments for mobile */
            .main-layout {
                flex-direction: column;
            }

            .left-column {
                flex: 1;
                width: 100%;
            }

            .right-column {
                flex: 1;
                width: 100%;
            }

            /* Header adjustments */
            .header {
                padding: 15px;
            }

            .bell-count {
                font-size: 1.2em;
            }

            /* Shop items - stack vertically */
            .shop-items {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .shop-item {
                padding: 12px;
            }

            /* Upgrades - single column */
            .upgrades {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .upgrade {
                padding: 12px;
            }

            .upgrade-header {
                flex-direction: column;
                gap: 8px;
            }

            .upgrade-button {
                width: 100%;
                padding: 10px;
                font-size: 0.9em;
            }

            /* Villager grid - 2 columns on mobile */
            .villagers-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .villager-slot {
                width: 100%;
                height: 80px;
            }

            .villager-portrait {
                width: 50px;
                height: 50px;
            }

            /* Villager selection modal */
            .villager-selection-content {
                width: 95%;
                max-width: 95%;
                padding: 15px;
                max-height: 90vh;
                overflow-y: auto;
            }

            .villager-selection-title {
                font-size: 1.2em;
                margin-bottom: 15px;
            }

            .villager-choices {
                flex-direction: column;
                gap: 12px;
            }

            .villager-choice {
                max-width: 100%;
                width: 100%;
                padding: 12px;
            }

            .villager-choice-portrait {
                width: 80px;
                height: 80px;
            }

            .villager-rarity-stars {
                font-size: 12px;
                left: 3px;
            }

            /* Fishing areas */
            .fishing-area {
                padding: 10px;
            }

            .fishing-area-top {
                flex-direction: column;
                gap: 10px;
            }

            .area-info {
                flex-direction: column;
                gap: 8px;
            }

            .area-text {
                min-width: 100%;
            }

            .area-progress-container {
                width: 100%;
            }

            .area-controls {
                justify-content: center;
                width: 100%;
            }

            /* Villager points section */
            .villager-points-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .point-item {
                padding: 10px;
            }

            /* Museum section */
            .museum-stats {
                flex-direction: column;
                gap: 8px;
            }

            .fish-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .fish-card {
                padding: 8px;
            }

            /* Tooltips - adjust for mobile */
            .villager-tooltip {
                font-size: 0.85em;
                min-width: 120px;
                top: 90px;
            }

            /* Calendar */
            .calendar {
                font-size: 0.85em;
                padding: 8px 12px;
            }

            /* Modals */
            .villager-assignment-modal-content {
                width: 95%;
                max-width: 95%;
                padding: 15px;
            }

            .assignment-options {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            /* Buttons */
            button {
                padding: 8px 12px;
                font-size: 0.9em;
            }

            /* Reset button */
            .reset-button {
                top: 10px;
                right: 70px;
                padding: 10px 20px;
                font-size: 1.2em;
            }
        }

        /* Extra small devices (phones in portrait, less than 480px) */
        @media (max-width: 480px) {
            .game-container {
                padding: 8px;
            }

            h1 {
                font-size: 1.2em;
            }

            .bell-count {
                font-size: 1em;
            }

            .villagers-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }

            .villager-slot {
                height: 70px;
            }

            .villager-portrait {
                width: 40px;
                height: 40px;
            }

            .fish-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }

            .villager-choice-portrait {
                width: 70px;
                height: 70px;
            }

            .villager-rarity-stars {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <button class="dark-mode-toggle" id="darkModeToggle" title="Toggle Dark Mode">üåô</button>
    <button class="lock-toggle locked" id="lockToggle" title="Toggle Layout Lock">üîí</button>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">üèùÔ∏è</div>
        <div class="loading-text">Loading Lazy Island...</div>
        <div class="loading-status" id="loadingStatus">Initializing...</div>
    </div>
    
    <!-- Villager Selection Modal -->
    <div class="villager-selection-modal" id="villagerSelectionModal">
        <div class="villager-selection-content">
            <div class="villager-selection-title">üèùÔ∏è Choose a Villager</div>
            <div class="villager-choices" id="villagerChoices">
                <!-- Villager choices will be inserted here -->
            </div>
        </div>
    </div>
    
    <!-- Villager Assignment Modal -->
    <div class="villager-assignment-modal" id="villagerAssignmentModal">
        <div class="villager-assignment-content">
            <div class="villager-assignment-title" id="assignmentModalTitle">Assign Villager</div>
            <div class="villager-assignment-list" id="villagerAssignmentList">
                <!-- Available villagers will be inserted here -->
            </div>
            <button class="assignment-cancel" onclick="closeAssignmentModal()">Cancel</button>
        </div>
    </div>
    
    <div class="game-container">
        <button class="reset-button" onclick="resetGame()" title="Start Over">üîÑ</button>
        
        <div class="middle-section">
            <div class="header">
                <h1>Lazy Island</h1>
                <div class="bell-count" id="bellCount">0 Bells</div>
                <div class="per-second">Generating: <span id="perSecond">0</span> Bells/sec</div>
            </div>
            
            <div class="island-activities-section">
                <div class="island-activities-header">
                    <div class="island-activities-title">üèùÔ∏è Island Activities</div>
                </div>
                <div class="upgrades-container" id="upgradesContainer">
                    <!-- Upgrades will be dynamically added here -->
                </div>
            </div>
            
            <div class="shop-section-wrapper">
                <div class="shop-section">
                    <div class="shop-header">
                        <h2 id="shopName">üè™ Nook's Cranny</h2>
                        <button class="shop-upgrade-btn" id="shopUpgradeBtn" style="display: none;" onclick="upgradeShop()">Upgrade</button>
                    </div>
                    <div class="shop-closed-message" id="shopClosedMessage" style="display: none;">
                        üö™ Shop is closed. Open the store to start selling items!
                    </div>
                    <div class="shop-items" id="shopContainer">
                        <!-- Activity point allocation will be added here -->
                    </div>
                    
                    <!-- Bell Clicker Button -->
                    <div class="bell-clicker-button" onclick="clickBellBag(event)">
                        <div class="bell-icon">üí∞</div>
                    </div>
                </div>
            </div>
            
            <!-- Villagers Grid -->
            <div class="villagers-section" id="villagersSection">
                <div class="villagers-grid" id="villagersGrid">
                    <!-- Villager slots will be dynamically added here -->
                </div>
            </div>
            
            <!-- Calendar and Museum Column -->
            <div class="calendar-museum-column">
                <!-- Calendar Section -->
                <div class="calendar-section">
                    <div class="calendar-header">
                        <div class="calendar-date" id="calendarDate">Jan 1</div>
                        <div class="calendar-day" id="calendarDay">Monday</div>
                    </div>
                    <div class="seasonal-fish">
                        <div class="seasonal-fish-title">üêü Fish in Season</div>
                        <div id="seasonalFishList">
                            <div class="no-fish">Loading...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Museum Section -->
                <div class="museum-section">
                    <div class="museum-header">
                        <div class="museum-title">üèõÔ∏è Museum</div>
                        <div class="museum-stats" id="museumStats">0 / 0 donated</div>
                    </div>
                    <div class="museum-progress">
                        <div class="museum-progress-text" id="museumProgressText">0%</div>
                        <div class="museum-progress-bar" id="museumProgressBar" style="width: 0%"></div>
                    </div>
                    <div class="museum-tabs">
                        <div class="museum-tab active" onclick="switchMuseumTab('caught')">Caught</div>
                        <div class="museum-tab" onclick="switchMuseumTab('missing')">Missing</div>
                    </div>
                    <div class="museum-fish-list" id="museumFishList">
                        <!-- Fish donation list will be added here -->
                    </div>
                    <div class="museum-reward" id="museumReward" style="display: none;">
                        üéâ Museum Bonus: +<span id="museumBonusAmount">0</span> Bells/sec
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Fish tooltip -->
        <div class="fish-tooltip" id="fishTooltip">
            <div class="fish-tooltip-content" id="tooltipContent">
                <!-- Image and details will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Dark Mode Toggle Functionality
        const darkModeToggle = document.getElementById('darkModeToggle');
        const body = document.body;
        
        // Check for saved dark mode preference
        const isDarkMode = localStorage.getItem('darkMode') === 'true';
        if (isDarkMode) {
            body.classList.add('dark-mode');
            darkModeToggle.textContent = '‚òÄÔ∏è';
        }
        
        // Toggle dark mode
        darkModeToggle.addEventListener('click', () => {
            body.classList.toggle('dark-mode');
            const isNowDark = body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isNowDark);
            darkModeToggle.textContent = isNowDark ? '‚òÄÔ∏è' : 'üåô';
        });

        // Draggable Container System
        let draggedElement = null;
        let dragOffset = { x: 0, y: 0 };
        let containerSizes = new Map();
        let snapPreview = null;

        // Lock Toggle Functionality
        const lockToggle = document.getElementById('lockToggle');
        let isLocked = localStorage.getItem('layoutLocked') !== 'false';
        
        // Set initial state
        if (!isLocked) {
            lockToggle.classList.remove('locked');
            lockToggle.textContent = 'üîì';
            enableDragging();
            const gameContainer = document.querySelector('.game-container');
            if (gameContainer) gameContainer.classList.add('show-grid');
        }
        
        lockToggle.addEventListener('click', () => {
            isLocked = !isLocked;
            lockToggle.classList.toggle('locked');
            lockToggle.textContent = isLocked ? 'üîí' : 'üîì';
            localStorage.setItem('layoutLocked', isLocked);
            
            const gameContainer = document.querySelector('.game-container');
            
            if (isLocked) {
                disableDragging();
                if (gameContainer) gameContainer.classList.remove('show-grid');
            } else {
                enableDragging();
                if (gameContainer) gameContainer.classList.add('show-grid');
            }
        });

        function enableDragging() {
            const containers = document.querySelectorAll('.island-activities-section, .shop-section-wrapper, .villagers-section, .calendar-section, .museum-section, .header');
            containers.forEach(container => {
                container.classList.add('draggable');
                container.style.cursor = 'move';
                
                // Store container size
                const computedStyle = window.getComputedStyle(container);
                const colMatch = computedStyle.gridColumn.match(/(\d+)\s*\/\s*span\s*(\d+)/);
                const rowMatch = computedStyle.gridRow.match(/(\d+)\s*\/\s*span\s*(\d+)/);
                if (colMatch && rowMatch) {
                    containerSizes.set(container, {
                        cols: parseInt(colMatch[2]),
                        rows: parseInt(rowMatch[2])
                    });
                }
                
                container.addEventListener('mousedown', handleMouseDown);
            });
        }

        function disableDragging() {
            const containers = document.querySelectorAll('.island-activities-section, .shop-section-wrapper, .villagers-section, .calendar-section, .museum-section, .header');
            containers.forEach(container => {
                container.classList.remove('draggable');
                container.style.cursor = '';
                container.removeEventListener('mousedown', handleMouseDown);
            });
        }

        function handleMouseDown(e) {
            if (!e.target.closest('.draggable')) return;
            
            draggedElement = e.currentTarget;
            draggedElement.classList.add('dragging');
            
            const gameContainer = document.querySelector('.game-container');
            const containerRect = gameContainer.getBoundingClientRect();
            const elementRect = draggedElement.getBoundingClientRect();
            
            // Calculate offset from mouse to element's top-left corner
            dragOffset.x = e.clientX - elementRect.left;
            dragOffset.y = e.clientY - elementRect.top;
            
            // Create snap preview
            snapPreview = document.createElement('div');
            snapPreview.className = 'grid-snap-preview';
            gameContainer.appendChild(snapPreview);
            
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
            
            e.preventDefault();
        }

        function handleMouseMove(e) {
            if (!draggedElement) return;
            
            const gameContainer = document.querySelector('.game-container');
            const containerRect = gameContainer.getBoundingClientRect();
            
            // Calculate position relative to game container (absolute positioning is relative to game-container)
            let x = e.clientX - containerRect.left - dragOffset.x;
            let y = e.clientY - containerRect.top - dragOffset.y;
            
            // Get container dimensions
            const elementWidth = draggedElement.offsetWidth;
            const elementHeight = draggedElement.offsetHeight;
            
            // Constrain to grid boundaries (24px padding + 1200px grid width/900px grid height)
            const minX = 24;
            const minY = 24;
            const maxX = 24 + 1200 - elementWidth;
            const maxY = 24 + 900 - elementHeight;
            
            x = Math.max(minX, Math.min(maxX, x));
            y = Math.max(minY, Math.min(maxY, y));
            
            // Position element absolutely during drag
            draggedElement.style.position = 'absolute';
            draggedElement.style.left = x + 'px';
            draggedElement.style.top = y + 'px';
            draggedElement.style.zIndex = '1000';
            
            // Update snap preview
            if (snapPreview) {
                // Calculate snap position
                const gridX = x - 24;
                const gridY = y - 24;
                const snapCol = Math.max(1, Math.min(12, Math.round(gridX / 100) + 1));
                const snapRow = Math.max(1, Math.min(9, Math.round(gridY / 100) + 1));
                
                const size = containerSizes.get(draggedElement) || { cols: 3, rows: 3 };
                const finalCol = Math.min(snapCol, 13 - size.cols);
                const finalRow = Math.min(snapRow, 10 - size.rows);
                
                // Position preview at snap location
                const previewX = 24 + (finalCol - 1) * 100;
                const previewY = 24 + (finalRow - 1) * 100;
                const previewWidth = size.cols * 100;
                const previewHeight = size.rows * 100;
                
                snapPreview.style.left = previewX + 'px';
                snapPreview.style.top = previewY + 'px';
                snapPreview.style.width = previewWidth + 'px';
                snapPreview.style.height = previewHeight + 'px';
            }
        }

        function checkCollision(col, row, cols, rows, excludeElement) {
            // Check if the proposed position collides with any existing container
            const containers = document.querySelectorAll('.island-activities-section, .shop-section-wrapper, .villagers-section, .calendar-section, .museum-section, .header');
            
            for (const container of containers) {
                if (container === excludeElement) continue;
                
                const style = window.getComputedStyle(container);
                const gridColumn = container.style.gridColumn || style.gridColumn;
                const gridRow = container.style.gridRow || style.gridRow;
                
                // Parse grid position
                const colMatch = gridColumn.match(/(\d+)\s*\/\s*span\s*(\d+)/);
                const rowMatch = gridRow.match(/(\d+)\s*\/\s*span\s*(\d+)/);
                
                if (!colMatch || !rowMatch) continue;
                
                const existingCol = parseInt(colMatch[1]);
                const existingCols = parseInt(colMatch[2]);
                const existingRow = parseInt(rowMatch[1]);
                const existingRows = parseInt(rowMatch[2]);
                
                // Check for overlap
                const colOverlap = col < existingCol + existingCols && col + cols > existingCol;
                const rowOverlap = row < existingRow + existingRows && row + rows > existingRow;
                
                if (colOverlap && rowOverlap) {
                    return true; // Collision detected
                }
            }
            
            return false; // No collision
        }

        function handleMouseUp(e) {
            if (!draggedElement) return;
            
            const gameContainer = document.querySelector('.game-container');
            
            // Store original position in case we need to revert
            const computedStyle = window.getComputedStyle(draggedElement);
            const originalGridColumn = draggedElement.style.gridColumn || computedStyle.gridColumn;
            const originalGridRow = draggedElement.style.gridRow || computedStyle.gridRow;
            
            // Get the current absolute position of the element
            const currentLeft = parseFloat(draggedElement.style.left) || 0;
            const currentTop = parseFloat(draggedElement.style.top) || 0;
            
            // Calculate grid position from the element's current position (accounting for 24px padding)
            const gridX = currentLeft - 24;
            const gridY = currentTop - 24;
            
            // Snap to grid (100px per cell)
            const gridCol = Math.max(1, Math.min(12, Math.round(gridX / 100) + 1));
            const gridRow = Math.max(1, Math.min(9, Math.round(gridY / 100) + 1));
            
            // Get container size
            const size = containerSizes.get(draggedElement) || { cols: 3, rows: 3 };
            
            // Ensure container doesn't go out of bounds
            const finalCol = Math.min(gridCol, 13 - size.cols);
            const finalRow = Math.min(gridRow, 10 - size.rows);
            
            // Check for collision
            const hasCollision = checkCollision(finalCol, finalRow, size.cols, size.rows, draggedElement);
            
            // Reset position styles
            draggedElement.style.position = '';
            draggedElement.style.left = '';
            draggedElement.style.top = '';
            draggedElement.style.zIndex = '';
            
            if (hasCollision) {
                // Collision detected - revert to original position
                draggedElement.style.gridColumn = originalGridColumn;
                draggedElement.style.gridRow = originalGridRow;
            } else {
                // No collision - apply new position
                draggedElement.style.gridColumn = `${finalCol} / span ${size.cols}`;
                draggedElement.style.gridRow = `${finalRow} / span ${size.rows}`;
                
                // Save layout to localStorage
                saveLayout();
            }
            
            draggedElement.classList.remove('dragging');
            
            // Remove snap preview
            if (snapPreview) {
                snapPreview.remove();
                snapPreview = null;
            }
            
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
            
            draggedElement = null;
        }

        function saveLayout() {
            const layout = {};
            const containers = document.querySelectorAll('.island-activities-section, .shop-section-wrapper, .villagers-section, .calendar-section, .museum-section, .header');
            
            containers.forEach((container, index) => {
                const id = container.id || container.className.split(' ')[0];
                layout[id] = {
                    gridColumn: container.style.gridColumn,
                    gridRow: container.style.gridRow
                };
            });
            
            localStorage.setItem('gridLayout', JSON.stringify(layout));
        }

        function loadLayout() {
            const savedLayout = localStorage.getItem('gridLayout');
            if (!savedLayout) return;
            
            try {
                const layout = JSON.parse(savedLayout);
                
                Object.keys(layout).forEach(id => {
                    const container = document.getElementById(id) || document.querySelector('.' + id);
                    if (container && layout[id].gridColumn && layout[id].gridRow) {
                        container.style.gridColumn = layout[id].gridColumn;
                        container.style.gridRow = layout[id].gridRow;
                    }
                });
            } catch (e) {
                console.error('Failed to load layout:', e);
            }
        }

        // Load saved layout on page load
        window.addEventListener('DOMContentLoaded', loadLayout);
        
        // Nookipedia API Configuration
        const NOOKIPEDIA_API_KEY = '8a10f688-39d6-40b8-8426-744f30542e94'; // Replace with your API key from https://api.nookipedia.com/
        const NOOKIPEDIA_API_URL = 'https://api.nookipedia.com/nh/fish';
        
        // Game state
        let bells = 400;
        let bellsPerSecond = 0;
        let totalBellsEarned = 0;
        let fishCache = [];
        let fishByLocation = {};
        let caughtFish = new Set(); // Track discovered/caught fish by name
        let donatedFish = new Set(); // Track fish donated to museum
        let villagersCache = []; // All available villagers from API
        let purchasedVillagers = []; // Villagers the player has bought
        let villagerCooldownEnd = 0; // Timestamp when villager can be purchased again
        let villagerHouses = 3; // Number of villager houses owned (starts at 3, max 10)
        let villagerAssignments = {}; // Maps upgrade.id to assigned villager object
        let hasCompletedInitialSelection = false; // Track if player has chosen initial 3 villagers
        let villagerPoints = {}; // Maps activity ID to number of villager points assigned (1 point = 10% speed boost)
        let rerollsRemaining = 3; // Number of free rerolls available during initial selection
        let currentVillagerChoices = []; // Current 3 villagers being shown in selection modal
        let inventory = {
            fishingRod: 0
        };
        
        // Store stage (1-4: Nook's Cranny, Nook 'n' Go, Nookway, Nookington's)
        let storeStage = 1;
        
        // Store upgrade tiers
        const storeTiers = [
            { stage: 1, name: 'üè™ Nook\'s Cranny', price: 100, cpsBonus: 1 },
            { stage: 2, name: 'üè™ Nook \'n\' Go', price: 100000, cpsBonus: 5 },
            { stage: 3, name: 'üè™ Nookway', price: 100000000, cpsBonus: 25 },
            { stage: 4, name: 'üè™ Nookington\'s', price: 100000000000, cpsBonus: 125 }
        ];
        
        // Fishing rod tier (1-6, affects fishing speed)
        let fishingRodTier = 1;
        let currentMuseumTab = 'caught'; // Track which museum tab is active
        
        // Progress tracking for each upgrade
        const upgradeProgress = {};
        
        // Fishing rod upgrade tiers
        // Speed multiplier is calculated dynamically based on villager count
        const fishingRodTiers = [
            { tier: 1, name: 'üé£ Flimsy Fishing Rod', price: 400 },
            { tier: 2, name: 'üé£ Fishing Rod', price: 4000 },
            { tier: 3, name: 'üåà Colorful Fishing Rod', price: 40000 },
            { tier: 4, name: 'üêü Fish Fishing Rod', price: 400000 },
            { tier: 5, name: 'üèûÔ∏è Outdoorsy Fishing Rod', price: 4000000 },
            { tier: 6, name: '‚≠ê Golden Fishing Rod', price: 40000000 }
        ];
        
        // Calculate speed multiplier for a fishing rod tier based on villager count
        // Each tier increases speed by 100% per villager owned
        function getRodSpeedMultiplier(tier) {
            const villagerCount = purchasedVillagers.length;
            // Speed increase = tier * 100% * villagerCount
            // Convert to multiplier: 1 / (1 + speedIncrease)
            const speedIncrease = (tier - 1) * 1.0 * villagerCount;
            return 1 / (1 + speedIncrease);
        }
        
        // Shop items - dynamically built based on fishing rod tier
        let shopItems = [];
        
        // Build shop items based on current fishing rod tier
        function buildShopItems() {
            shopItems = [];
            
            // Show only one fishing rod at a time
            // Priority: initial rod if not owned, otherwise next upgrade
            if (inventory.fishingRod === 0) {
                // Add initial fishing rod if not owned
                shopItems.push({
                    id: 'fishingRod',
                    name: 'üé£ Flimsy Fishing Rod',
                    description: 'A basic fishing rod.',
                    price: 400,
                    inventoryKey: 'fishingRod',
                    maxPurchases: 1
                });
            } else if (fishingRodTier < 6) {
                // Add next fishing rod upgrade if available (only if initial rod is owned)
                const nextTier = fishingRodTiers.find(t => t.tier === fishingRodTier + 1);
                if (nextTier) {
                    const villagerCount = purchasedVillagers.length;
                    const speedBonus = (nextTier.tier - 1) * 100 * villagerCount;
                    const description = villagerCount > 0 
                        ? `${speedBonus}% faster fishing!`
                        : 'Upgrade your fishing rod!';
                    shopItems.push({
                        id: `fishingRodUpgrade${nextTier.tier}`,
                        name: nextTier.name,
                        description: description,
                        price: nextTier.price,
                        isRodUpgrade: true,
                        tier: nextTier.tier
                    });
                }
            }
            
            // Store upgrades are now handled by the upgrade button, not shop items
        }
        
        // Fishing area progress tracking
        const fishingAreaProgress = {};
        const fishingAreaNextCatch = {}; // Stores the next catch time for each area
        
        // Get current fishing speed multiplier (includes rod tier + villager point bonuses)
        function getFishingSpeedMultiplier() {
            const baseMult = getRodSpeedMultiplier(fishingRodTier);
            
            // Apply villager point bonus: each point = 50% faster
            // Formula: 1 / (1 + (points * 0.5))
            // 1 point: 1/1.5 = 0.667x time (50% faster)
            // 2 points: 1/2.0 = 0.5x time (100% faster)
            // 3 points: 1/2.5 = 0.4x time (150% faster)
            const fishingPoints = villagerPoints['fishing'] || 0;
            const villagerBonus = 1 / (1 + (fishingPoints * 0.5));
            
            return baseMult * villagerBonus;
        }
        
        // Get base fishing interval (30-45 seconds)
        function getBaseFishingInterval() {
            return 30 + Math.random() * 15;
        }
        
        // Get actual fishing interval with speed multiplier
        function getFishingInterval() {
            return getBaseFishingInterval() * getFishingSpeedMultiplier();
        }
        
        // Fishing area allocations
        const fishingAreas = [
            {
                id: 'river',
                name: 'üèûÔ∏è River',
                description: 'Freshwater fish',
                fishTypes: ['River', 'River (mouth)', 'River (clifftop)'],
                rods: 0
            },
            {
                id: 'ocean',
                name: 'üåä Ocean',
                description: 'Saltwater fish',
                fishTypes: ['Sea'],
                rods: 0
            },
            {
                id: 'pier',
                name: 'üé£ Pier',
                description: 'Large ocean fish',
                fishTypes: ['Pier'],
                rods: 0
            },
            {
                id: 'pond',
                name: 'ü¶Ü Pond',
                description: 'Small freshwater fish',
                fishTypes: ['Pond'],
                rods: 0
            }
        ];

        // Upgrade definitions with generation intervals
        const upgrades = [
            {
                id: 'villager',
                name: 'üê± Villager',
                description: 'A friendly villager who helps gather Bells',
                baseCost: 100,
                cps: 100,
                interval: 30
            },
            {
                id: 'orchard',
                name: 'üå≥ Fruit Orchard',
                description: 'Grows fruit trees for steady income',
                baseCost: 1100,
                cps: 8,
                interval: 8,
                owned: 0
            },
            {
                id: 'museum',
                name: 'üèõÔ∏è Museum',
                description: 'Attracts tourists who donate Bells',
                baseCost: 130000,
                cps: 260,
                interval: 12,
                owned: 0
            },
            {
                id: 'island',
                name: 'üèùÔ∏è Mystery Island',
                description: 'Discover rare items and resources',
                baseCost: 1400000,
                cps: 1400,
                interval: 15,
                owned: 0
            },
            {
                id: 'nook',
                name: 'ü¶ù Tom Nook',
                description: 'The ultimate entrepreneur generates massive Bells',
                baseCost: 20000000,
                cps: 7800,
                interval: 10,
                owned: 0
            },
            {
                id: 'kk',
                name: 'üé∏ K.K. Slider Concert',
                description: 'Weekly concerts bring in huge crowds',
                baseCost: 330000000,
                cps: 44000,
                interval: 20,
                owned: 0
            }
        ];
        
        // Initialize progress for each upgrade
        upgrades.forEach(upgrade => {
            upgradeProgress[upgrade.id] = 0;
        });
        
        // Initialize fishing area progress
        fishingAreas.forEach(area => {
            fishingAreaProgress[area.id] = 0;
            // Random interval between 30-45 seconds, affected by rod tier
            fishingAreaNextCatch[area.id] = getFishingInterval();
        });
        
        // Click bell bag to earn 10 bells
        function clickBellBag(event) {
            bells += 10;
            totalBellsEarned += 10;
            updateDisplay();
            
            // Create floating +10 text
            const bellSection = event.currentTarget;
            const floatingText = document.createElement('div');
            floatingText.className = 'bell-click-text';
            floatingText.textContent = '+10';
            
            // Position at click location
            const rect = bellSection.getBoundingClientRect();
            floatingText.style.left = (rect.width / 2 - 20) + 'px';
            floatingText.style.top = (rect.height / 2 - 15) + 'px';
            
            bellSection.appendChild(floatingText);
            
            // Remove after animation completes
            setTimeout(() => {
                floatingText.remove();
            }, 1000);
        }
        
        // Update calendar display
        function updateCalendar() {
            const now = new Date();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            const month = months[now.getMonth()];
            const date = now.getDate();
            const day = days[now.getDay()];
            
            calendarDateEl.textContent = `${month} ${date}`;
            calendarDayEl.textContent = day;
        }
        
        // Check if fish is available in current month (Northern Hemisphere)
        function isFishInSeason(fish) {
            if (!fish.north || !fish.north.months_array) return true; // If no data, assume available
            
            const currentMonth = new Date().getMonth() + 1; // 1-12
            return fish.north.months_array.includes(currentMonth);
        }
        
        // Show fish tooltip
        function showFishTooltip(event, fish) {
            const tooltip = document.getElementById('fishTooltip');
            const tooltipContent = document.getElementById('tooltipContent');
            
            if (!tooltip || !fish) return;
            
            let imageHTML = '';
            let detailsHTML = '';
            
            // Add fish image if available
            if (fish.image_url) {
                imageHTML = '<img src="' + fish.image_url + '" alt="' + fish.name + '" class="fish-tooltip-image" onerror="this.style.display=\'none\'">';
            } else {
                imageHTML = '<div class="fish-tooltip-image-placeholder">üêü</div>';
            }
            
            // Build details column
            detailsHTML += '<div class="fish-tooltip-details">';
            detailsHTML += '<div class="fish-tooltip-name">' + fish.name + '</div>';
            detailsHTML += '<div class="fish-tooltip-info">';
            
            if (fish.sell) {
                detailsHTML += `
                    <div class="fish-tooltip-row">
                        <span class="fish-tooltip-label">Sell Price:</span>
                        <span class="fish-tooltip-value">${fish.sell.toLocaleString()} Bells</span>
                    </div>
                `;
            }
            
            if (fish.location) {
                detailsHTML += `
                    <div class="fish-tooltip-row">
                        <span class="fish-tooltip-label">Location:</span>
                        <span class="fish-tooltip-value">${fish.location}</span>
                    </div>
                `;
            }
            
            // Show months available
            if (fish.north && fish.north.months) {
                const monthsStr = fish.north.months || 'All year';
                detailsHTML += `
                    <div class="fish-tooltip-row">
                        <span class="fish-tooltip-label">Months:</span>
                        <span class="fish-tooltip-value">${monthsStr}</span>
                    </div>
                `;
            }
            
            // Show time of day available
            if (fish.north && fish.north.availability_array) {
                const times = fish.north.availability_array;
                const timeStr = times.length > 0 ? times.map(t => {
                    const start = t.time.split('-')[0];
                    const end = t.time.split('-')[1];
                    return `${start}-${end}`;
                }).join(', ') : 'All day';
                
                detailsHTML += `
                    <div class="fish-tooltip-row">
                        <span class="fish-tooltip-label">Time:</span>
                        <span class="fish-tooltip-value">${timeStr}</span>
                    </div>
                `;
            }
            
            detailsHTML += detailsHTML.includes('fish-tooltip-row') ? '' : '<div style="color: #999; font-style: italic; font-size: 0.75em;">No additional info</div>';
            detailsHTML += '</div>'; // Close fish-tooltip-info
            detailsHTML += '</div>'; // Close fish-tooltip-details
            
            // Combine image and details
            tooltipContent.innerHTML = imageHTML + detailsHTML;
            
            // Position tooltip near mouse
            const x = event.clientX + 15;
            const y = event.clientY + 15;
            
            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
            tooltip.classList.add('show');
        }
        
        // Update tooltip position as mouse moves
        function updateTooltipPosition(event) {
            const tooltip = document.getElementById('fishTooltip');
            if (tooltip && tooltip.classList.contains('show')) {
                const x = event.clientX + 15;
                const y = event.clientY + 15;
                tooltip.style.left = x + 'px';
                tooltip.style.top = y + 'px';
            }
        }
        
        // Hide fish tooltip
        function hideFishTooltip() {
            const tooltip = document.getElementById('fishTooltip');
            if (tooltip) {
                tooltip.classList.remove('show');
            }
        }
        
        // Update seasonal fish display
        function updateSeasonalFish() {
            if (fishCache.length === 0) {
                seasonalFishListEl.innerHTML = '<div class="no-fish">Loading fish data...</div>';
                return;
            }
            
            // Filter fish that are in season AND have been caught
            const seasonalFish = fishCache.filter(fish => 
                isFishInSeason(fish) && caughtFish.has(fish.name)
            );
            
            if (seasonalFish.length === 0) {
                seasonalFishListEl.innerHTML = '<div class="no-fish">No fish discovered yet</div>';
                return;
            }
            
            // Group by location
            const fishByLoc = {};
            seasonalFish.forEach(fish => {
                const loc = fish.location || 'Unknown';
                if (!fishByLoc[loc]) {
                    fishByLoc[loc] = [];
                }
                fishByLoc[loc].push(fish);
            });
            
            // Build HTML
            let html = '';
            const locationOrder = ['River', 'Pond', 'Sea', 'Pier', 'River (Clifftop)', 'River (Mouth)'];
            const locationIcons = {
                'River': 'üèûÔ∏è',
                'Pond': 'ü¶Ü',
                'Sea': 'üåä',
                'Pier': 'üé£',
                'River (Clifftop)': '‚õ∞Ô∏è',
                'River (Mouth)': 'üåä'
            };
            
            // Sort locations
            const sortedLocations = Object.keys(fishByLoc).sort((a, b) => {
                const aIndex = locationOrder.indexOf(a);
                const bIndex = locationOrder.indexOf(b);
                if (aIndex === -1 && bIndex === -1) return a.localeCompare(b);
                if (aIndex === -1) return 1;
                if (bIndex === -1) return -1;
                return aIndex - bIndex;
            });
            
            sortedLocations.forEach(location => {
                const fish = fishByLoc[location];
                const icon = locationIcons[location] || 'üìç';
                html += `
                    <div class="fish-location-group">
                        <div class="fish-location-name">${icon} ${location}</div>
                        <div class="fish-list">
                            ${fish.slice(0, 8).map(f => `
                                <div class="fish-tag" 
                                     onmouseenter="showFishTooltip(event, ${JSON.stringify(f).replace(/"/g, '&quot;')})" 
                                     onmouseleave="hideFishTooltip()">
                                    ${f.name}
                                </div>
                            `).join('')}
                            ${fish.length > 8 ? `<div class="fish-tag">+${fish.length - 8} more</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            seasonalFishListEl.innerHTML = html;
        }
        
        // Switch museum tab between caught and missing
        function switchMuseumTab(tab) {
            currentMuseumTab = tab;
            
            // Update tab styling
            const tabs = document.querySelectorAll('.museum-tab');
            tabs.forEach(tabEl => {
                if ((tab === 'caught' && tabEl.textContent === 'Caught') ||
                    (tab === 'missing' && tabEl.textContent === 'Missing')) {
                    tabEl.classList.add('active');
                } else {
                    tabEl.classList.remove('active');
                }
            });
            
            // Refresh the museum display
            updateMuseumDisplay();
        }
        
        // Update museum display
        function updateMuseumDisplay() {
            const museumStats = document.getElementById('museumStats');
            const museumProgressBar = document.getElementById('museumProgressBar');
            const museumProgressText = document.getElementById('museumProgressText');
            const museumFishList = document.getElementById('museumFishList');
            const museumReward = document.getElementById('museumReward');
            const museumBonusAmount = document.getElementById('museumBonusAmount');
            
            if (!museumStats || !museumFishList) return;
            
            const totalFish = fishCache.length;
            const donatedCount = donatedFish.size;
            const percentage = totalFish > 0 ? Math.floor((donatedCount / totalFish) * 100) : 0;
            
            // Update stats
            museumStats.textContent = `${donatedCount} / ${totalFish} donated`;
            museumProgressBar.style.width = percentage + '%';
            museumProgressText.textContent = percentage + '%';
            
            // Show reward if any fish donated
            if (donatedCount > 0) {
                museumReward.style.display = 'block';
                const bonusAmount = donatedCount * 100;
                museumBonusAmount.textContent = formatNumber(bonusAmount);
            } else {
                museumReward.style.display = 'none';
            }
            
            // Build fish list
            museumFishList.innerHTML = '';
            
            if (fishCache.length === 0) {
                museumFishList.innerHTML = '<div style="text-align: center; padding: 8px; color: #999; font-size: 0.7em;">Loading fish data...</div>';
                return;
            }
            
            // Sort fish by name
            const sortedFish = [...fishCache].sort((a, b) => a.name.localeCompare(b.name));
            
            sortedFish.forEach(fish => {
                const isCaught = caughtFish.has(fish.name);
                const isDonated = donatedFish.has(fish.name);
                
                // Filter based on active tab
                if (currentMuseumTab === 'caught') {
                    // Show only caught fish
                    if (!isCaught) {
                        return;
                    }
                } else if (currentMuseumTab === 'missing') {
                    // Show only missing (not caught) fish
                    if (isCaught) {
                        return;
                    }
                }
                
                const fishItem = document.createElement('div');
                fishItem.className = `museum-fish-item ${isCaught ? 'caught' : 'not-caught'}`;
                
                let statusIcon = '';
                if (isDonated) {
                    statusIcon = 'üèõÔ∏è';
                } else if (isCaught) {
                    statusIcon = '‚úÖ';
                } else {
                    statusIcon = '‚ùì';
                }
                
                fishItem.innerHTML = `
                    <span class="museum-fish-name">${fish.name}</span>
                    <span class="museum-fish-status">${statusIcon}</span>
                `;
                
                // Add tooltip event listeners
                fishItem.addEventListener('mouseenter', (e) => showFishTooltip(e, fish));
                fishItem.addEventListener('mouseleave', hideFishTooltip);
                fishItem.addEventListener('mousemove', updateTooltipPosition);
                
                museumFishList.appendChild(fishItem);
            });
        }
        
        // Donate a fish to the museum (manual donation - not used with auto-donate)
        function donateFish(fishName) {
            // This function is kept for backwards compatibility but won't be called
            // since fish are auto-donated on first catch
            return;
        }
        
        // Fetch item prices from Nookipedia API
        async function fetchItemPrices() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    console.log('Item price API request timed out');
                    controller.abort();
                }, 8000); // 8 second timeout for API
                
                const response = await fetch('https://api.nookipedia.com/nh/tools', {
                    method: 'GET',
                    headers: {
                        'X-API-KEY': NOOKIPEDIA_API_KEY,
                        'Accept-Version': '1.0.0'
                    },
                    signal: controller.signal,
                    mode: 'cors'
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const tools = await response.json();
                    const fishingRod = tools.find(tool => tool.name.toLowerCase().includes('flimsy fishing rod'));
                    
                    if (fishingRod) {
                        const rodItem = shopItems.find(item => item.id === 'fishingRod');
                        if (rodItem) {
                            // Handle different API response formats
                            let price = 400; // Default fallback
                            
                            if (typeof fishingRod.buy === 'number') {
                                price = fishingRod.buy;
                            } else if (fishingRod.buy && typeof fishingRod.buy === 'object' && fishingRod.buy.value) {
                                price = fishingRod.buy.value;
                            } else if (fishingRod.sell) {
                                price = typeof fishingRod.sell === 'number' ? fishingRod.sell : 500;
                            }
                            
                            rodItem.price = price;
                            // Update the display immediately
                            createShopItems();
                        }
                    }
                } else {
                    console.warn('Failed to fetch item prices:', response.status);
                }
            } catch (error) {
                console.warn('Could not fetch item prices from API:', error.message);
                console.log('Using default item prices');
            }
        }
        
        // Initialize fallback data immediately
        function initializeFallbackData() {
            // Create 80 placeholder fish so museum counter shows correct total during loading
            fishCache = [];
            for (let i = 1; i <= 80; i++) {
                fishCache.push({
                    name: `Fish ${i}`,
                    sell: 400,
                    size: 'Medium',
                    location: 'Sea'
                });
            }
            
            // Organize fish by location
            fishByLocation = {};
            fishCache.forEach(fish => {
                const loc = fish.location;
                if (!fishByLocation[loc]) {
                    fishByLocation[loc] = [];
                }
                fishByLocation[loc].push(fish);
            });
            
            updateSeasonalFish();
        }
        
        // Update loading status
        function updateLoadingStatus(message) {
            const statusEl = document.getElementById('loadingStatus');
            if (statusEl) {
                statusEl.textContent = message;
            }
        }
        
        // Hide loading overlay
        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        }
        
        // Fetch API data in background
        async function fetchAPIDataInBackground() {
            updateLoadingStatus('Loading villagers...');
            const villagersDataPromise = fetchVillagersFromAPI();
            
            updateLoadingStatus('Loading fish data...');
            const fishDataPromise = fetchFishData();
            
            // Wait for all to complete
            await Promise.all([fishDataPromise, villagersDataPromise]);
            
            updateLoadingStatus('Finalizing...');
            
            // Update UI after API data loads
            buildShopItems();
            createShopItems();
            updateSeasonalFish();
            
            // Hide loading overlay
            setTimeout(() => {
                hideLoadingOverlay();
            }, 500);
        }
        
        // Fetch fish data from Nookipedia API
        async function fetchFishData() {
            if (NOOKIPEDIA_API_KEY === 'YOUR_API_KEY_HERE') {
                console.warn('Nookipedia API key not set. Using fallback fish data.');
                return;
            }
            
            // Fallback data already loaded, just try to fetch from API
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    console.log('API request timed out after 8 seconds');
                    controller.abort();
                }, 8000); // 8 second timeout
                
                const response = await fetch(NOOKIPEDIA_API_URL, {
                    method: 'GET',
                    headers: {
                        'X-API-KEY': NOOKIPEDIA_API_KEY,
                        'Accept-Version': '1.0.0'
                    },
                    signal: controller.signal,
                    mode: 'cors'
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const rawFish = await response.json();
                    // Normalize fish data from API
                    const apiFishCache = rawFish.map(fish => ({
                        name: fish.name,
                        sell: fish.sell_nook || fish.sell || 400,
                        size: fish.shadow_size || fish.size || 'Medium',
                        location: fish.location || 'Sea',
                        north: fish.north,
                        image_url: fish.image_url || fish.render_url || null
                    }));
                    
                    // Only update if we got valid data
                    if (apiFishCache.length > 0) {
                        // Check for duplicates
                        const fishNames = new Set();
                        const duplicates = [];
                        apiFishCache.forEach(fish => {
                            if (fishNames.has(fish.name)) {
                                duplicates.push(fish.name);
                            }
                            fishNames.add(fish.name);
                        });
                        
                        if (duplicates.length > 0) {
                            console.warn(`‚ö†Ô∏è Found ${duplicates.length} duplicate fish:`, duplicates);
                        }
                        
                        fishCache = apiFishCache;
                        
                        // Organize fish by location
                        fishByLocation = {};
                        fishCache.forEach(fish => {
                            const loc = fish.location;
                            if (!fishByLocation[loc]) {
                                fishByLocation[loc] = [];
                            }
                            fishByLocation[loc].push(fish);
                        });
                        
                        console.log(`üêü Loaded ${fishCache.length} fish from API`);
                        
                        // Clean up caught/donated fish that don't exist in current fish cache
                        const validFishNames = new Set(fishCache.map(f => f.name));
                        const invalidCaught = [];
                        const invalidDonated = [];
                        
                        caughtFish.forEach(fishName => {
                            if (!validFishNames.has(fishName)) {
                                invalidCaught.push(fishName);
                            }
                        });
                        
                        donatedFish.forEach(fishName => {
                            if (!validFishNames.has(fishName)) {
                                invalidDonated.push(fishName);
                            }
                        });
                        
                        // Remove invalid entries
                        invalidCaught.forEach(name => caughtFish.delete(name));
                        invalidDonated.forEach(name => donatedFish.delete(name));
                        
                        if (invalidCaught.length > 0 || invalidDonated.length > 0) {
                            console.log(`üßπ Cleaned up ${invalidCaught.length} invalid caught fish and ${invalidDonated.length} invalid donated fish`);
                        }
                    }
                } else {
                    // Failed to fetch fish data, using fallback
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.warn('Fish API request timed out - keeping fallback data');
                } else {
                    console.warn('Error fetching fish data:', error.name, error.message);
                }
                // Fallback data already loaded, no need to reload
            }
        }
        
        // Fetch villagers from Nookipedia API
        async function fetchVillagersFromAPI() {
            // Load fallback villagers first (curated list of popular villagers)
            if (villagersCache.length === 0) {
                villagersCache = [
                    { name: 'Bob', species: 'Cat', personality: 'Lazy', image_url: null, rarity: 1 },
                    { name: 'Rosie', species: 'Cat', personality: 'Peppy', image_url: null, rarity: 1 },
                    { name: 'Marshal', species: 'Squirrel', personality: 'Smug', image_url: null, rarity: 6 },
                    { name: 'Raymond', species: 'Cat', personality: 'Smug', image_url: null, rarity: 9 },
                    { name: 'Ankha', species: 'Cat', personality: 'Snooty', image_url: null, rarity: 1 },
                    { name: 'Stitches', species: 'Cub', personality: 'Lazy', image_url: null, rarity: 1 },
                    { name: 'Fauna', species: 'Deer', personality: 'Normal', image_url: null, rarity: 4 },
                    { name: 'Zucker', species: 'Octopus', personality: 'Lazy', image_url: null, rarity: 6 },
                    { name: 'Judy', species: 'Cub', personality: 'Snooty', image_url: null, rarity: 9 },
                    { name: 'Sherb', species: 'Goat', personality: 'Lazy', image_url: null, rarity: 9 },
                    { name: 'Audie', species: 'Wolf', personality: 'Peppy', image_url: null, rarity: 9 },
                    { name: 'Dom', species: 'Sheep', personality: 'Jock', image_url: null, rarity: 9 },
                    { name: 'Molly', species: 'Duck', personality: 'Normal', image_url: null, rarity: 6 },
                    { name: 'Marina', species: 'Octopus', personality: 'Normal', image_url: null, rarity: 6 },
                    { name: 'Merengue', species: 'Rhino', personality: 'Normal', image_url: null, rarity: 6 },
                    { name: 'Coco', species: 'Rabbit', personality: 'Normal', image_url: null, rarity: 1 },
                    { name: 'Lucky', species: 'Dog', personality: 'Lazy', image_url: null, rarity: 1 },
                    { name: 'Maple', species: 'Cub', personality: 'Normal', image_url: null, rarity: 1 },
                    { name: 'Lolly', species: 'Cat', personality: 'Normal', image_url: null, rarity: 6 },
                    { name: 'Tangy', species: 'Cat', personality: 'Peppy', image_url: null, rarity: 1 }
                ];
            }
            
            // Try to fetch from API
            if (NOOKIPEDIA_API_KEY === 'YOUR_API_KEY_HERE') {
                console.warn('Nookipedia API key not set. Using fallback villager data.');
                return;
            }
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    console.log('Villagers API request timed out after 8 seconds');
                    controller.abort();
                }, 8000);
                
                const response = await fetch('https://api.nookipedia.com/villagers', {
                    method: 'GET',
                    headers: {
                        'X-API-KEY': NOOKIPEDIA_API_KEY,
                        'Accept-Version': '1.0.0'
                    },
                    signal: controller.signal,
                    mode: 'cors'
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const rawVillagers = await response.json();
                    
                    // Normalize villager data from API
                    const apiVillagers = rawVillagers.map(villager => {
                        // Calculate rarity from appearances if available
                        let rarity = 5; // Default
                        if (villager.appearances && Array.isArray(villager.appearances)) {
                            const mainGames = ['DNM', 'AC', 'E_PLUS', 'WW', 'CF', 'NL', 'WA', 'NH', 'HHD', 'PC'];
                            const gameCount = villager.appearances.filter(game => 
                                mainGames.some(mainGame => game.toUpperCase().includes(mainGame))
                            ).length;
                            
                            if (gameCount >= 10) rarity = 1;
                            else if (gameCount >= 9) rarity = 2;
                            else if (gameCount >= 8) rarity = 3;
                            else if (gameCount >= 7) rarity = 4;
                            else if (gameCount >= 6) rarity = 5;
                            else if (gameCount >= 5) rarity = 6;
                            else if (gameCount >= 4) rarity = 7;
                            else if (gameCount >= 3) rarity = 8;
                            else if (gameCount >= 2) rarity = 9;
                            else if (gameCount >= 1) rarity = 10;
                        }
                        
                        return {
                            name: villager.name,
                            species: villager.species,
                            personality: villager.personality,
                            image_url: villager.icon_url || villager.image_url || villager.photo_url || null,
                            rarity: rarity,
                            appearances: villager.appearances || []
                        };
                    });
                    
                    // Only update if we got valid data
                    if (apiVillagers.length > 0) {
                        villagersCache = apiVillagers;
                        console.log(`üèòÔ∏è Loaded ${villagersCache.length} villagers from API`);
                        
                        // Update villager grid if we have purchased villagers
                        if (purchasedVillagers.length > 0) {
                            updateVillagersGrid();
                        }
                    }
                } else {
                    console.warn('Failed to fetch villagers:', response.status);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.warn('Villagers API request timed out - keeping fallback data');
                } else {
                    console.warn('Error fetching villagers:', error.name, error.message);
                }
            }
        }
        
        // Get house purchase price
        function getHousePrice() {
            // Price increases exponentially: 5000, 10000, 20000, 40000, 80000, 160000, 320000
            return 50000 * Math.pow(2, villagerHouses - 3);
        }
        
        // Buy a new house
        function buyHouse() {
            if (villagerHouses >= 10) {
                console.log('Maximum houses reached');
                return;
            }
            
            const price = getHousePrice();
            if (bells >= price) {
                bells -= price;
                villagerHouses++;
                updateDisplay();
                initVillagersGrid(); // Rebuild grid with new slot
                updateVillagersGrid(); // Update slot contents
                console.log(`üè† Purchased a new house! Villager slots: ${villagerHouses}/10`);
            } else {
                console.log(`Not enough bells for house. Need: ${formatNumber(price)}, Have: ${formatNumber(bells)}`);
            }
        }
        
        // Initialize villagers grid
        function initVillagersGrid() {
            const grid = document.getElementById('villagersGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            // Create slots for owned houses
            for (let i = 0; i < villagerHouses; i++) {
                const slot = document.createElement('div');
                slot.className = 'villager-slot empty';
                slot.id = `villager-slot-${i}`;
                grid.appendChild(slot);
            }
            
            // Add one "buy house" slot if not at max
            if (villagerHouses < 10) {
                const buySlot = document.createElement('div');
                buySlot.className = 'villager-slot buy-house';
                buySlot.id = 'buy-house-slot';
                buySlot.onclick = buyHouse;
                const price = getHousePrice();
                buySlot.innerHTML = `
                    <div class="buy-house-icon">üîî</div>
                    <div class="buy-house-price">${formatNumber(price)}</div>
                `;
                buySlot.title = `Buy House (${formatNumber(price)} üîî)`;
                grid.appendChild(buySlot);
            }
        }
        
        // Update villagers grid display
        function updateVillagersGrid() {
            const section = document.getElementById('villagersSection');
            const grid = document.getElementById('villagersGrid');
            
            if (!section || !grid) return;
            
            // Show section if we have villagers or houses
            if (purchasedVillagers.length > 0 || villagerHouses > 0) {
                section.classList.add('visible');
            } else {
                section.classList.remove('visible');
                return;
            }
            
            // Update buy house slot if it exists
            const buySlot = document.getElementById('buy-house-slot');
            if (buySlot) {
                const price = getHousePrice();
                buySlot.innerHTML = `
                    <div class="buy-house-icon">üîî</div>
                    <div class="buy-house-price">${formatNumber(price)}</div>
                `;
                buySlot.title = `Buy House (${formatNumber(price)} üîî)`;
            }
            
            // Update each villager slot
            for (let i = 0; i < villagerHouses; i++) {
                const slot = document.getElementById(`villager-slot-${i}`);
                if (!slot) continue;
                
                if (i < purchasedVillagers.length) {
                    const villager = purchasedVillagers[i];
                    slot.className = 'villager-slot';
                    const imageHtml = villager.image_url ? `<img src="${villager.image_url}" alt="${villager.name}" class="villager-portrait" onerror="this.style.display='none'">` : '<div class="villager-placeholder">üê±</div>';
                    
                    const rarityRow = villager.rarity ? `
                        <div class="villager-tooltip-row">
                            <span class="villager-tooltip-label">Rarity:</span>
                            <span>${villager.rarity}/10</span>
                        </div>
                    ` : '';
                    
                    const tooltipHtml = `
                        <div class="villager-tooltip">
                            <div class="villager-tooltip-name">${villager.name}</div>
                            <div class="villager-tooltip-info">
                                <div class="villager-tooltip-row">
                                    <span class="villager-tooltip-label">Species:</span>
                                    <span>${villager.species || 'Unknown'}</span>
                                </div>
                                <div class="villager-tooltip-row">
                                    <span class="villager-tooltip-label">Type:</span>
                                    <span>${villager.personality || 'Unknown'}</span>
                                </div>
                                ${rarityRow}
                            </div>
                        </div>
                    `;
                    
                    slot.innerHTML = `
                        ${imageHtml}
                        ${tooltipHtml}
                    `;
                    
                    // Add click handler to open Nookipedia page
                    slot.onclick = () => {
                        const villagerName = villager.name.replace(/\s+/g, '_');
                        window.open(`https://nookipedia.com/wiki/${villagerName}`, '_blank');
                    };
                } else {
                    slot.className = 'villager-slot empty';
                    slot.innerHTML = '';
                    slot.onclick = null;
                }
            }
        }
        
        // Get random villager that hasn't been purchased yet
        function getRandomVillager() {
            if (villagersCache.length === 0) {
                // Fallback if API hasn't loaded
                return {
                    name: 'Villager ' + (purchasedVillagers.length + 1),
                    image_url: null,
                    species: 'Unknown',
                    personality: 'Unknown'
                };
            }
            
            // Filter out already purchased villagers
            const purchasedNames = new Set(purchasedVillagers.map(v => v.name));
            const availableVillagers = villagersCache.filter(v => !purchasedNames.has(v.name));
            
            if (availableVillagers.length === 0) {
                // All villagers purchased, pick any random one
                return villagersCache[Math.floor(Math.random() * villagersCache.length)];
            }
            
            return availableVillagers[Math.floor(Math.random() * availableVillagers.length)];
        }
        
        // Get 3 random villagers for selection
        function getRandomVillagerChoices(count = 3) {
            const choices = [];
            const purchasedNames = new Set(purchasedVillagers.map(v => v.name));
            const availableVillagers = villagersCache.filter(v => !purchasedNames.has(v.name));
            
            if (availableVillagers.length === 0) {
                // All villagers purchased, use all villagers
                const shuffled = [...villagersCache].sort(() => Math.random() - 0.5);
                return shuffled.slice(0, count);
            }
            
            // Get random unique villagers
            const shuffled = [...availableVillagers].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, Math.min(count, shuffled.length));
        }
        
        // Show villager selection modal
        function showVillagerSelection(isInitialSelection = false) {
            const modal = document.getElementById('villagerSelectionModal');
            const choicesContainer = document.getElementById('villagerChoices');
            
            if (!modal || !choicesContainer) return;
            
            // Get 3 random villagers if starting fresh or rerolling
            if (currentVillagerChoices.length === 0) {
                currentVillagerChoices = getRandomVillagerChoices(3);
            }
            
            // Clear previous choices
            choicesContainer.innerHTML = '';
            
            // Update title for initial selection
            const titleEl = modal.querySelector('.villager-selection-title');
            if (titleEl && isInitialSelection) {
                const remaining = 3 - purchasedVillagers.length;
                const rerollButton = rerollsRemaining > 0 ? `<button onclick="rerollVillagers()" style="
                    background: linear-gradient(135deg, #6BAA5E 0%, #5A9A4D 100%);
                    color: white;
                    border: none;
                    padding: 4px 10px;
                    border-radius: 6px;
                    font-size: 0.75em;
                    font-weight: bold;
                    cursor: pointer;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                    transition: transform 0.2s;
                    margin-left: 10px;
                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    üîÑ Reroll (${rerollsRemaining})
                </button>` : '';
                titleEl.innerHTML = `Choose Your Starting Villagers<br><span style="font-size: 0.8em; color: #999;">(${remaining} picks remaining)${rerollButton}</span>`;
            } else if (titleEl) {
                titleEl.textContent = 'üèùÔ∏è Choose a Villager';
            }
            
            // Create choice elements
            currentVillagerChoices.forEach((villager, index) => {
                const choiceDiv = document.createElement('div');
                choiceDiv.className = 'villager-choice';
                choiceDiv.onclick = () => selectVillagerFromChoices(index, isInitialSelection);
                
                const imageHtml = villager.image_url 
                    ? `<img src="${villager.image_url}" alt="${villager.name}" class="villager-choice-portrait" onerror="this.style.display='none'">` 
                    : '<div class="villager-placeholder" style="font-size: 3em;">üê±</div>';
                
                // Generate rarity stars (vertical display)
                const rarity = villager.rarity || 5;
                const starsHtml = `
                    <div class="villager-rarity-stars">
                        ${Array(rarity).fill('‚≠ê').map(star => `<span class="star">${star}</span>`).join('')}
                    </div>
                `;
                
                choiceDiv.innerHTML = `
                    ${starsHtml}
                    ${imageHtml}
                    <div class="villager-choice-name">${villager.name}</div>
                    <div class="villager-choice-info">${villager.species}</div>
                    <div class="villager-choice-info">${villager.personality}</div>
                `;
                
                choicesContainer.appendChild(choiceDiv);
            });
            
            // Show modal
            modal.classList.add('active');
        }
        
        // Reroll all villager choices (only during initial selection)
        function rerollVillagers() {
            if (rerollsRemaining > 0) {
                rerollsRemaining--;
                currentVillagerChoices = getRandomVillagerChoices(3);
                showVillagerSelection(true);
                console.log(`üîÑ Rerolled villagers! ${rerollsRemaining} rerolls remaining.`);
            }
        }
        
        // Select a villager from the current choices by index
        function selectVillagerFromChoices(index, isInitialSelection = false) {
            const villager = currentVillagerChoices[index];
            if (!villager) return;
            
            const modal = document.getElementById('villagerSelectionModal');
            
            // Add villager to purchased list
            purchasedVillagers.push(villager);
            updateVillagersGrid();
            
            // Handle initial selection flow
            if (isInitialSelection) {
                // Replace only the selected villager with a new one
                const purchasedNames = new Set(purchasedVillagers.map(v => v.name));
                const availableVillagers = villagersCache.filter(v => !purchasedNames.has(v.name));
                
                if (availableVillagers.length > 0) {
                    const newVillager = availableVillagers[Math.floor(Math.random() * availableVillagers.length)];
                    currentVillagerChoices[index] = newVillager;
                }
                
                // Check if we've selected 3 villagers
                if (purchasedVillagers.length < 3) {
                    // Continue showing selection with updated choices
                    setTimeout(() => showVillagerSelection(true), 300);
                } else {
                    // Completed initial selection
                    hasCompletedInitialSelection = true;
                    currentVillagerChoices = []; // Clear choices
                    rerollsRemaining = 3; // Reset for next time (though shouldn't happen)
                    modal.classList.remove('active');
                    console.log('üèùÔ∏è Initial villagers selected! You now have 3 villager points to assign.');
                    saveGame(); // Save the initial selection
                }
            } else {
                // Normal villager purchase - set 24-hour cooldown
                villagerCooldownEnd = Date.now() + (24 * 60 * 60 * 1000);
                currentVillagerChoices = []; // Clear choices
                modal.classList.remove('active');
            }
            
            // Update display
            calculateCPS();
            updateDisplay();
            updateUpgradeButtons();
            updateVillagerPointsUI();
        }
        
        
        // Open assignment modal for an upgrade
        let currentAssignmentUpgradeId = null;
        
        function openAssignmentModal(upgradeId) {
            currentAssignmentUpgradeId = upgradeId;
            const modal = document.getElementById('villagerAssignmentModal');
            const title = document.getElementById('assignmentModalTitle');
            const listContainer = document.getElementById('villagerAssignmentList');
            
            if (!modal || !title || !listContainer) return;
            
            // Find upgrade name
            const upgrade = upgrades.find(u => u.id === upgradeId);
            title.textContent = `Assign Villager to ${upgrade ? upgrade.name : 'Activity'}`;
            
            // Clear list
            listContainer.innerHTML = '';
            
            // Get already assigned villagers
            const assignedVillagers = Object.values(villagerAssignments);
            const assignedNames = new Set(assignedVillagers.map(v => v.name));
            
            // Show all purchased villagers
            purchasedVillagers.forEach(villager => {
                const isAssigned = assignedNames.has(villager.name);
                const itemDiv = document.createElement('div');
                itemDiv.className = `villager-assignment-item ${isAssigned ? 'assigned' : ''}`;
                
                if (!isAssigned) {
                    itemDiv.onclick = () => assignVillagerToUpgrade(upgradeId, villager);
                }
                
                const imageHtml = villager.image_url 
                    ? `<img src="${villager.image_url}" alt="${villager.name}" class="villager-choice-portrait" onerror="this.style.display='none'">` 
                    : '<div class="villager-placeholder" style="font-size: 3em;">üê±</div>';
                
                const statusText = isAssigned ? '<div style="color: #999; font-size: 0.8em;">Already Assigned</div>' : '';
                
                itemDiv.innerHTML = `
                    ${imageHtml}
                    <div class="villager-choice-name">${villager.name}</div>
                    <div class="villager-choice-info">${villager.species}</div>
                    <div class="villager-choice-info">${villager.personality}</div>
                    ${statusText}
                `;
                
                listContainer.appendChild(itemDiv);
            });
            
            // Show modal
            modal.classList.add('active');
        }
        
        function closeAssignmentModal() {
            const modal = document.getElementById('villagerAssignmentModal');
            if (modal) {
                modal.classList.remove('active');
            }
            currentAssignmentUpgradeId = null;
        }
        
        // Assign a villager to an upgrade
        function assignVillagerToUpgrade(upgradeId, villager) {
            // Check if villager is already assigned elsewhere
            for (const [existingUpgradeId, assignedVillager] of Object.entries(villagerAssignments)) {
                if (assignedVillager.name === villager.name) {
                    console.log(`${villager.name} is already assigned to another activity`);
                    return;
                }
            }
            
            // Assign villager
            villagerAssignments[upgradeId] = villager;
            
            // Update displays
            updateAssignedVillagers();
            updateVillagersGrid();
            calculateCPS();
            updateDisplay();
            
            // Close modal
            closeAssignmentModal();
        }
        
        // Unassign a villager from an upgrade
        function unassignVillager(upgradeId) {
            delete villagerAssignments[upgradeId];
            
            // Update displays
            updateAssignedVillagers();
            updateVillagersGrid();
            calculateCPS();
            updateDisplay();
        }
        
        // Update the assigned villagers display for all upgrades
        function updateAssignedVillagers() {
            upgrades.forEach(upgrade => {
                if (upgrade.id === 'villager') return; // Skip villager upgrade
                
                const container = document.getElementById(`assigned-villagers-${upgrade.id}`);
                const listEl = document.getElementById(`assigned-list-${upgrade.id}`);
                
                if (!container || !listEl) return;
                
                const assignedVillager = villagerAssignments[upgrade.id];
                
                if (assignedVillager) {
                    container.style.display = 'block';
                    
                    const imageHtml = assignedVillager.image_url 
                        ? `<img src="${assignedVillager.image_url}" alt="${assignedVillager.name}" class="assigned-villager-portrait" onerror="this.style.display='none'">` 
                        : '<div style="font-size: 1.5em;">üë§</div>';
                    
                    listEl.innerHTML = `
                        <div class="assigned-villager-item">
                            ${imageHtml}
                            <div class="assigned-villager-name">${assignedVillager.name}</div>
                            <button class="unassign-button" onclick="event.stopPropagation(); unassignVillager('${upgrade.id}')">Remove</button>
                        </div>
                    `;
                } else if (upgrade.owned > 0) {
                    // Show assignment section if upgrade is owned, but no villager assigned
                    container.style.display = 'block';
                    listEl.innerHTML = '<div style="color: #999; font-style: italic; padding: 8px;">No villager assigned</div>';
                } else {
                    // Hide if upgrade not owned
                    container.style.display = 'none';
                }
            });
        }
        
        // Display fish caught message
        function displayFishMessage(fish, isDonation = false) {
            const messageEl = document.getElementById('fishing-catch-message');
            if (!messageEl) return;
            
            if (isDonation) {
                messageEl.textContent = `üèõÔ∏è Donated: ${fish.name}`;
            } else {
                messageEl.textContent = `üé£ Caught: ${fish.name}`;
            }
            
            // Remove message after 5 seconds
            setTimeout(() => {
                if (messageEl) {
                    messageEl.textContent = '';
                }
            }, 5000);
        }
        
        // Get random fish from specific area with rarity-based weighting
        function getRandomFishFromArea(area) {
            let availableFish = [];
            
            // Get fish matching this area's types
            area.fishTypes.forEach(type => {
                if (fishByLocation[type]) {
                    availableFish = availableFish.concat(fishByLocation[type]);
                }
            });
            
            // Fallback to all fish if no matches
            if (availableFish.length === 0) {
                availableFish = fishCache;
            }
            
            if (availableFish.length === 0) return null;
            
            // Calculate weights based on rarity (inverse of price)
            // Lower price = higher weight (more common)
            // Higher price = lower weight (more rare)
            const weights = availableFish.map(fish => {
                const price = fish.sell || 400;
                // Use inverse square root for more gradual rarity scaling
                // Common fish (200-500): weight ~0.045-0.071
                // Uncommon (1000-3000): weight ~0.018-0.032
                // Rare (5000-10000): weight ~0.010-0.014
                // Ultra rare (15000+): weight ~0.008
                return 1 / Math.sqrt(price);
            });
            
            // Calculate total weight
            const totalWeight = weights.reduce((sum, w) => sum + w, 0);
            
            // Random selection based on weights
            let random = Math.random() * totalWeight;
            for (let i = 0; i < availableFish.length; i++) {
                random -= weights[i];
                if (random <= 0) {
                    return availableFish[i];
                }
            }
            
            // Fallback (shouldn't reach here)
            return availableFish[availableFish.length - 1];
        }
        
        // Toggle fishing area (only one can be active at a time)
        function toggleFishingArea(areaId) {
            if (inventory.fishingRod === 0) return;
            
            const area = fishingAreas.find(a => a.id === areaId);
            if (!area) return;
            
            // Deactivate all areas
            fishingAreas.forEach(a => a.rods = 0);
            
            // Activate clicked area
            area.rods = 1;
            
            // Hide instruction message after first activation
            const instructionEl = document.getElementById('fishing-areas-instruction');
            if (instructionEl) {
                instructionEl.style.display = 'none';
            }
            
            updateFishingAreasUI();
        }
        
        // Update fishing areas UI
        function updateFishingAreasUI() {
            const container = document.getElementById('fishing-areas-container');
            if (!container) return;
            
            if (inventory.fishingRod === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            // Show instruction if no area is active
            const instructionEl = document.getElementById('fishing-areas-instruction');
            const hasActiveArea = fishingAreas.some(a => a.rods > 0);
            if (instructionEl) {
                instructionEl.style.display = hasActiveArea ? 'none' : 'block';
            }
                        
            fishingAreas.forEach(area => {
                const areaEl = document.getElementById(`fishing-area-${area.id}`);
                
                if (areaEl) {
                    if (area.rods > 0) {
                        areaEl.classList.add('active');
                    } else {
                        areaEl.classList.remove('active');
                    }
                }
            });
        }


        // Villager Points Management
        function getAvailableVillagerPoints() {
            const totalPoints = purchasedVillagers.length;
            const assignedPoints = Object.values(villagerPoints).reduce((sum, val) => sum + val, 0);
            return totalPoints - assignedPoints;
        }

        function assignVillagerPoint(activityId) {
            const available = getAvailableVillagerPoints();
            if (available > 0) {
                villagerPoints[activityId] = (villagerPoints[activityId] || 0) + 1;
                
                // Recalculate fishing timers to apply speed boost immediately
                if (activityId === 'fishing') {
                    fishingAreas.forEach(area => {
                        if (area.rods > 0 && fishingAreaNextCatch[area.id]) {
                            const currentProgress = fishingAreaProgress[area.id] || 0;
                            const oldTarget = fishingAreaNextCatch[area.id];
                            const percentComplete = currentProgress / oldTarget;
                            
                            // Calculate new target with updated speed
                            const newTarget = getFishingInterval();
                            fishingAreaNextCatch[area.id] = newTarget;
                            
                            // Adjust progress to maintain same percentage completion
                            fishingAreaProgress[area.id] = percentComplete * newTarget;
                        }
                    });
                }
                
                updateVillagerPointsUI();
                updateFishingAreasUI(); // Refresh fishing UI to show new speed
                saveGame();
            }
        }

        function removeVillagerPoint(activityId) {
            if (villagerPoints[activityId] && villagerPoints[activityId] > 0) {
                villagerPoints[activityId]--;
                if (villagerPoints[activityId] === 0) {
                    delete villagerPoints[activityId];
                }
                
                // Recalculate fishing timers to apply speed change immediately
                if (activityId === 'fishing') {
                    fishingAreas.forEach(area => {
                        if (area.rods > 0 && fishingAreaNextCatch[area.id]) {
                            const currentProgress = fishingAreaProgress[area.id] || 0;
                            const oldTarget = fishingAreaNextCatch[area.id];
                            const percentComplete = currentProgress / oldTarget;
                            
                            // Calculate new target with updated speed
                            const newTarget = getFishingInterval();
                            fishingAreaNextCatch[area.id] = newTarget;
                            
                            // Adjust progress to maintain same percentage completion
                            fishingAreaProgress[area.id] = percentComplete * newTarget;
                        }
                    });
                }
                
                updateVillagerPointsUI();
                updateFishingAreasUI(); // Refresh fishing UI to show new speed
                saveGame();
            }
        }

        function updateVillagerPointsUI() {
            const section = document.getElementById('villagerPointsSection');
            const availableEl = document.getElementById('availablePoints');
            const listContainer = document.getElementById('activityPointsList');
            
            if (!section || !availableEl || !listContainer) return;
            
            // Show section if player has villagers
            if (purchasedVillagers.length > 0) {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
                return;
            }
            
            const available = getAvailableVillagerPoints();
            availableEl.textContent = available;
            
            // Define activities that can receive points
            const activities = [
                { id: 'fishing', name: 'üé£', description: 'Faster fishing in all areas' }
            ];
            
            // Clear and rebuild list
            listContainer.innerHTML = '';
            
            activities.forEach(activity => {
                const points = villagerPoints[activity.id] || 0;
                const bonus = points * 50; // 50% per point
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'activity-point-item';
                itemDiv.innerHTML = `
                    <div class="activity-point-name">${activity.name}</div>
                    <div class="activity-point-bonus">+${bonus}% speed</div>
                    <div class="activity-point-controls">
                        <button class="point-button" onclick="removeVillagerPoint('${activity.id}')" ${points === 0 ? 'disabled' : ''}>-</button>
                        <div class="activity-point-count">${points}</div>
                        <button class="point-button" onclick="assignVillagerPoint('${activity.id}')" ${available === 0 ? 'disabled' : ''}>+</button>
                    </div>
                `;
                listContainer.appendChild(itemDiv);
            });
        }

        // DOM elements - will be initialized after DOM loads
        let bellCountEl, perSecondEl, upgradesContainer, shopContainer;
        let calendarDateEl, calendarDayEl, seasonalFishListEl;
        
        // Initialize DOM elements
        function initDOMElements() {
            bellCountEl = document.getElementById('bellCount');
            perSecondEl = document.getElementById('perSecond');
            upgradesContainer = document.getElementById('upgradesContainer');
            shopContainer = document.getElementById('shopContainer');
            calendarDateEl = document.getElementById('calendarDate');
            calendarDayEl = document.getElementById('calendarDay');
            seasonalFishListEl = document.getElementById('seasonalFishList');
        }

        // Calculate upgrade cost with scaling
        function getUpgradeCost(upgrade) {
            // Villagers are free
            if (upgrade.id === 'villager') {
                return 0;
            }
            return Math.floor(upgrade.baseCost * Math.pow(1.15, upgrade.owned));
        }

        // Format numbers
        function formatNumber(num) {
            if (num >= 1000000000) return (num / 1000000000).toFixed(2) + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
            return Math.floor(num).toString();
        }

        // Update display
        function updateDisplay() {
            bellCountEl.textContent = formatNumber(bells) + ' Bells';
            perSecondEl.textContent = formatNumber(bellsPerSecond);
            updateUpgradeButtons();
            updateShopItems();
            updateShopUpgradeButton();
        }
        
        // Update shop name based on current store stage
        function updateShopName() {
            const shopNameEl = document.getElementById('shopName');
            const currentStore = storeTiers[storeStage - 1];
            shopNameEl.textContent = currentStore.name;
            updateShopVisibility();
        }
        
        // Update shop items visibility based on whether store is open
        function updateShopVisibility() {
            const shopContainer = document.getElementById('shopContainer');
            const closedMessage = document.getElementById('shopClosedMessage');
            
            // Shop is always open
            shopContainer.classList.remove('closed');
            closedMessage.style.display = 'none';
        }
        
        // Update shop upgrade button visibility and text
        function updateShopUpgradeButton() {
            const upgradeBtn = document.getElementById('shopUpgradeBtn');
            
            if (storeStage < 4) {
                const nextStore = storeTiers[storeStage];
                const canAfford = bells >= nextStore.price;
                
                upgradeBtn.style.display = 'block';
                upgradeBtn.textContent = `Upgrade (${formatNumber(nextStore.price)} Bells)`;
                upgradeBtn.disabled = !canAfford;
            } else {
                upgradeBtn.style.display = 'none';
            }
        }
        
        // Upgrade shop function
        function upgradeShop() {
            if (storeStage >= 4) return;
            
            const nextStore = storeTiers[storeStage];
            if (bells >= nextStore.price) {
                bells -= nextStore.price;
                storeStage = nextStore.stage;
                
                updateShopName();
                updateDisplay();
                calculateCPS();
                
                console.log(`üè™ Upgraded to ${nextStore.name}! +${nextStore.cpsBonus} Bells/sec`);
            }
        }

        // Create shop items
        function createShopItems() {
            shopContainer.innerHTML = '';
            shopItems.forEach(item => {
                // Ensure price is a number
                if (typeof item.price !== 'number') {
                    console.warn(`Invalid price for ${item.name}, resetting to 500`);
                    item.price = 500;
                }
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shop-item';
                itemDiv.id = `shop-${item.id}`;
                
                itemDiv.innerHTML = `
                    <div class="shop-item-header">
                        <div class="shop-item-name">${item.name}</div>
                        <div class="shop-item-price" id="shop-price-${item.id}">${formatNumber(item.price)} Bells</div>
                    </div>
                    <div class="shop-item-description">${item.description}</div>
                    <div class="shop-item-owned">Owned: <span id="shop-owned-${item.id}">0</span></div>
                `;
                
                itemDiv.addEventListener('click', () => buyShopItem(item));
                shopContainer.appendChild(itemDiv);
            });
        }
        
        // Update shop items UI
        function updateShopItems() {
            shopItems.forEach(item => {
                const itemDiv = document.getElementById(`shop-${item.id}`);
                const ownedEl = document.getElementById(`shop-owned-${item.id}`);
                
                if (ownedEl) {
                    ownedEl.textContent = inventory[item.inventoryKey] || 0;
                }
                
                if (itemDiv) {
                    const owned = inventory[item.inventoryKey] || 0;
                    const maxReached = item.maxPurchases && owned >= item.maxPurchases;
                    
                    if (maxReached) {
                        itemDiv.classList.add('shop-item-disabled');
                        itemDiv.style.opacity = '0.5';
                        itemDiv.style.cursor = 'not-allowed';
                    } else if (bells >= item.price) {
                        itemDiv.classList.remove('shop-item-disabled');
                        itemDiv.style.opacity = '1';
                        itemDiv.style.cursor = 'pointer';
                    } else {
                        itemDiv.classList.add('shop-item-disabled');
                        itemDiv.style.opacity = '1';
                        itemDiv.style.cursor = 'pointer';
                    }
                }
            });
        }
        
        // Buy shop item
        function buyShopItem(item) {
            // Handle fishing rod upgrades
            if (item.isRodUpgrade) {
                if (bells >= item.price) {
                    bells -= item.price;
                    fishingRodTier = item.tier;
                    
                    // Reset all fishing area timers with new speed
                    fishingAreas.forEach(area => {
                        if (area.rods > 0) {
                            fishingAreaNextCatch[area.id] = getFishingInterval();
                        }
                    });
                    
                    buildShopItems();
                    createShopItems();
                    updateDisplay();
                    updateFishingAreasUI();
                    
                    const speedBonus = Math.round((1 - fishingRodTiers.find(t => t.tier === item.tier).speedMultiplier) * 100);
                    console.log(`üé£ Upgraded to ${item.name}! Fishing speed increased by ${speedBonus}%`);
                }
                return;
            }
            
            // Handle regular items
            const owned = inventory[item.inventoryKey] || 0;
            
            // Check if max purchases reached
            if (item.maxPurchases && owned >= item.maxPurchases) {
                console.log(`Cannot buy more ${item.name} - maximum reached`);
                return;
            }
            
            if (bells >= item.price) {
                bells -= item.price;
                inventory[item.inventoryKey]++;
                buildShopItems();
                createShopItems(); // Refresh shop UI to show upgrades
                updateDisplay();
                updateShopItems();
                updateFishingAreasUI();
            }
        }
        
        // Upgrade fishing rod (deprecated - now handled in shop)
        function upgradeFishingRod() {
            // This function is no longer used - upgrades are in the shop
            return;
        }
        
        // Create upgrade buttons
        function createUpgradeButtons() {
            upgradesContainer.innerHTML = '';
            
            // Create fishing areas card
            const fishingDiv = document.createElement('div');
            fishingDiv.className = 'upgrade-item';
            fishingDiv.id = 'upgrade-fishing';
            
            const currentRodTier = fishingRodTiers.find(t => t.tier === fishingRodTier);
            
            fishingDiv.innerHTML = `
                <div class="upgrade-header">
                    <div class="upgrade-info">
                        <div class="upgrade-name">Fishing Areas</div>
                    </div>
                </div>
                <div class="fishing-areas" id="fishing-areas-container" style="display: none;">
                    <div class="fishing-areas-header">
                        <div class="fishing-catch-message" id="fishing-catch-message"></div>
                    </div>
                    
                    <div class="fishing-areas-instruction" id="fishing-areas-instruction">Pick a spot to start fishing!</div>
                    ${fishingAreas.map(area => `
                        <div class="fishing-area" id="fishing-area-${area.id}" onclick="toggleFishingArea('${area.id}')">
                            <div class="fishing-area-top">
                                <div class="area-text">
                                    <div class="area-name">${area.name}</div>
                                    <div class="area-fish-types">${area.description}</div>
                                </div>
                            </div>
                            <div class="area-progress-container">
                                <div class="area-progress-bar" id="area-progress-bar-${area.id}" style="width: 0%"></div>
                            </div>
                        </div>
                    `).join('')}
                    
                    <!-- Villager Points Allocation -->
                    <div class="villager-points-section" id="villagerPointsSection" style="display: none; margin-top: 10px;">
                        <div class="villager-points-title">‚≠ê Villager Points</div>
                        <div class="villager-points-info">
                            Available: <span id="availablePoints">0</span> | Each point = 50% speed boost
                        </div>
                        <div id="activityPointsList">
                            <!-- Activity point allocation will be added here -->
                        </div>
                    </div>
                </div>
            `;
            
            upgradesContainer.appendChild(fishingDiv);
            
            // Add other upgrades
            upgrades.forEach(upgrade => {
                const upgradeDiv = document.createElement('div');
                upgradeDiv.className = 'upgrade-item';
                upgradeDiv.id = `upgrade-${upgrade.id}`;
                
                const cost = getUpgradeCost(upgrade);
                const cooldownHtml = upgrade.id === 'villager' ? `<div class="villager-cooldown" id="cooldown-${upgrade.id}" style="display: none; color: #F7B32B; font-size: 0.9em; margin-top: 5px;"></div>` : '';
                const costHtml = upgrade.id === 'villager' ? '' : `<div class="upgrade-cost" id="cost-${upgrade.id}">${formatNumber(cost)} üîî</div>`;
                
                // Skip villager upgrade (it's not an activity to assign to)
                const assignmentHtml = upgrade.id !== 'villager' ? `
                    <div class="assigned-villagers" id="assigned-villagers-${upgrade.id}" style="display: none;">
                        <div style="font-weight: bold; margin-bottom: 5px;">üë• Assigned Villagers:</div>
                        <div id="assigned-list-${upgrade.id}"></div>
                        <button class="assign-button" onclick="event.stopPropagation(); openAssignmentModal('${upgrade.id}')">+ Assign Villager</button>
                    </div>
                ` : '';
                
                upgradeDiv.innerHTML = `
                    <div class="upgrade-header">
                        <div class="upgrade-info">
                            <div class="upgrade-name">${upgrade.name}</div>
                            <div class="upgrade-description">${upgrade.description}</div>
                            <div class="upgrade-owned">Owned: <span id="owned-${upgrade.id}">0</span></div>
                            <div class="production-rate" id="production-${upgrade.id}">Generates: 0 Bells/${upgrade.interval}s</div>
                            ${cooldownHtml}
                        </div>
                        ${costHtml}
                    </div>
                    <div class="progress-bar-container" id="progress-container-${upgrade.id}" style="display: none;">
                        <div class="progress-text" id="progress-text-${upgrade.id}">0%</div>
                        <div class="progress-bar" id="progress-bar-${upgrade.id}" style="width: 0%"></div>
                    </div>
                    ${assignmentHtml}
                `;
                
                upgradeDiv.addEventListener('click', () => buyUpgrade(upgrade));
                upgradesContainer.appendChild(upgradeDiv);
            });
        }

        // Update upgrade button states
        function updateUpgradeButtons() {
            upgrades.forEach(upgrade => {
                const cost = getUpgradeCost(upgrade);
                const upgradeDiv = document.getElementById(`upgrade-${upgrade.id}`);
                const costEl = document.getElementById(`cost-${upgrade.id}`);
                const ownedEl = document.getElementById(`owned-${upgrade.id}`);
                const productionEl = document.getElementById(`production-${upgrade.id}`);
                const progressContainer = document.getElementById(`progress-container-${upgrade.id}`);
                const cooldownEl = document.getElementById(`cooldown-${upgrade.id}`);
                
                // Check if max owned limit reached
                const maxReached = upgrade.maxOwned && upgrade.owned >= upgrade.maxOwned;
                
                // Check villager cooldown
                const onCooldown = upgrade.id === 'villager' && isVillagerOnCooldown();
                
                if (upgradeDiv) {
                    if (maxReached || onCooldown) {
                        upgradeDiv.classList.add('disabled');
                    } else if (bells >= cost) {
                        upgradeDiv.classList.remove('disabled');
                    } else {
                        upgradeDiv.classList.add('disabled');
                    }
                }
                
                // Update cooldown display for villager
                if (cooldownEl) {
                    if (onCooldown) {
                        const remaining = formatCooldownTime(getRemainingCooldown());
                        cooldownEl.textContent = `‚è∞ Next villager in: ${remaining}`;
                        cooldownEl.style.display = 'block';
                    } else {
                        cooldownEl.style.display = 'none';
                    }
                }
                
                if (costEl) {
                    if (maxReached) {
                        costEl.textContent = 'MAX';
                    } else {
                        costEl.textContent = formatNumber(cost) + ' üîî';
                    }
                }
                
                if (ownedEl) {
                    if (upgrade.maxOwned) {
                        ownedEl.textContent = `${upgrade.owned}/${upgrade.maxOwned}`;
                    } else {
                        ownedEl.textContent = upgrade.owned;
                    }
                }
                
                // Show/hide progress bar based on ownership
                if (progressContainer) {
                    if (upgrade.owned > 0) {
                        progressContainer.style.display = 'block';
                        let bellsPerInterval = upgrade.cps * upgrade.owned;
                        
                        // Apply villager bonus
                        if (villagerAssignments[upgrade.id]) {
                            bellsPerInterval *= 1.5;
                        }
                        
                        if (productionEl) {
                            const bellsPerSec = bellsPerInterval / upgrade.interval;
                            if (villagerAssignments[upgrade.id]) {
                                productionEl.innerHTML = `Generates: ${formatNumber(bellsPerSec)} Bells/sec <span style="color: #6BAA5E; font-weight: bold;">(+50% üë•)</span>`;
                            } else {
                                productionEl.textContent = `Generates: ${formatNumber(bellsPerSec)} Bells/sec`;
                            }
                        }
                    } else {
                        progressContainer.style.display = 'none';
                        if (productionEl) {
                            const bellsPerSec = upgrade.cps / upgrade.interval;
                            productionEl.textContent = `Generates: ${formatNumber(bellsPerSec)} Bells/sec each`;
                        }
                    }
                }
            });
        }
        
        // Update progress bars
        function updateProgressBars() {
            upgrades.forEach(upgrade => {
                if (upgrade.owned > 0) {
                    const progressBar = document.getElementById(`progress-bar-${upgrade.id}`);
                    const progressText = document.getElementById(`progress-text-${upgrade.id}`);
                    
                    if (progressBar && progressText) {
                        const progress = upgradeProgress[upgrade.id];
                        const percentage = (progress / upgrade.interval) * 100;
                        progressBar.style.width = percentage + '%';
                        progressText.textContent = Math.floor(percentage) + '%';
                    }
                }
            });
            
            // Update fishing area progress bars
            fishingAreas.forEach(area => {
                if (area.rods > 0) {
                    const progressBar = document.getElementById(`area-progress-bar-${area.id}`);
                    
                    if (progressBar) {
                        const progress = fishingAreaProgress[area.id];
                        const nextCatch = fishingAreaNextCatch[area.id];
                        const percentage = (progress / nextCatch) * 100; // Variable interval (30-45s)
                        progressBar.style.width = percentage + '%';
                    }
                }
            });
        }

        // Check if villager cooldown is active
        function isVillagerOnCooldown() {
            return Date.now() < villagerCooldownEnd;
        }
        
        // Get remaining cooldown time in milliseconds
        function getRemainingCooldown() {
            return Math.max(0, villagerCooldownEnd - Date.now());
        }
        
        // Format cooldown time for display
        function formatCooldownTime(ms) {
            const hours = Math.floor(ms / (1000 * 60 * 60));
            const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((ms % (1000 * 60)) / 1000);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds}s`;
            } else {
                return `${seconds}s`;
            }
        }
        
        // Buy upgrade
        function buyUpgrade(upgrade) {
            // Special handling for villager upgrade
            if (upgrade.id === 'villager') {
                // Check if we have space for more villagers (based on houses)
                if (purchasedVillagers.length >= villagerHouses) {
                    console.log(`No empty houses! Villagers: ${purchasedVillagers.length}/${villagerHouses}. Buy more houses to invite more villagers.`);
                    return;
                }
                
                // Check villager cooldown
                if (isVillagerOnCooldown()) {
                    const remaining = formatCooldownTime(getRemainingCooldown());
                    console.log(`‚è∞ Villager on cooldown. Can invite another in ${remaining}`);
                    return;
                }
                
                // Show villager selection modal (free, no cost)
                upgrade.owned++;
                showVillagerSelection();
                updateDisplay();
                updateUpgradeButtons();
                return;
            }
            
            // Check if max owned limit reached
            if (upgrade.maxOwned && upgrade.owned >= upgrade.maxOwned) {
                return;
            }
            
            const cost = getUpgradeCost(upgrade);
            if (bells >= cost) {
                bells -= cost;
                upgrade.owned++;
                
                calculateCPS();
                updateDisplay();
            }
        }

        // Calculate Bells per second
        function calculateCPS() {
            bellsPerSecond = 0;
            upgrades.forEach(upgrade => {
                // cps represents bells per interval, so divide by interval to get per second
                let baseCPS = (upgrade.cps / upgrade.interval) * upgrade.owned;
                
                // Apply villager bonus (50% increase if assigned)
                if (villagerAssignments[upgrade.id]) {
                    baseCPS *= 1.5;
                }
                
                bellsPerSecond += baseCPS;
            });
            
            // Add store bonus (passive income from store upgrades)
            if (storeStage > 0) {
                const currentStore = storeTiers[storeStage - 1];
                bellsPerSecond += currentStore.cpsBonus;
            }
            
            // Add museum bonus (100 bells/sec per donated fish)
            bellsPerSecond += donatedFish.size * 100;
        }


        // Game loop - runs every 100ms (0.1 seconds)
        setInterval(() => {
            const deltaTime = 0.1; // 100ms in seconds
            
            // Update progress for each owned upgrade
            upgrades.forEach(upgrade => {
                if (upgrade.owned > 0) {
                    upgradeProgress[upgrade.id] += deltaTime;
                    
                    // Check if interval completed
                    if (upgradeProgress[upgrade.id] >= upgrade.interval) {
                        const cycles = Math.floor(upgradeProgress[upgrade.id] / upgrade.interval);
                        const bellsGenerated = upgrade.cps * upgrade.owned * cycles;
                        bells += bellsGenerated;
                        totalBellsEarned += bellsGenerated;
                        upgradeProgress[upgrade.id] %= upgrade.interval;
                        
                    }
                }
            });
            
            updateDisplay();
            updateProgressBars();
        }, 100);
        
        // Fishing loop - runs every 100ms
        setInterval(() => {
            if (fishCache.length === 0) return;
            
            const deltaTime = 0.1; // 100ms in seconds
            
            // Update progress for each fishing area with assigned rods
            fishingAreas.forEach(area => {
                if (area.rods > 0) {
                    fishingAreaProgress[area.id] += deltaTime;
                    
                    // Check if variable interval completed (30-45 seconds)
                    if (fishingAreaProgress[area.id] >= fishingAreaNextCatch[area.id]) {
                        const fish = getRandomFishFromArea(area);
                        if (fish) {
                            let isNewFish = false;
                            let isDonation = false;
                            
                            // Add fish to caught list if not already there
                            if (!caughtFish.has(fish.name)) {
                                caughtFish.add(fish.name);
                                isNewFish = true;
                                updateSeasonalFish(); // Update calendar when new fish is discovered
                                
                                // Auto-donate to museum if not already donated
                                if (!donatedFish.has(fish.name)) {
                                    donatedFish.add(fish.name);
                                    isDonation = true;
                                    calculateCPS(); // Recalculate for museum bonus
                                    updateMuseumDisplay(); // Update museum display
                                }
                            }
                            
                            // Only earn bells if fish was already donated (not a donation)
                            if (!isDonation) {
                                const fishValue = fish.sell || 0;
                                bells += fishValue * area.rods;
                                totalBellsEarned += fishValue * area.rods;
                            }
                            
                            displayFishMessage(fish, isDonation);
                        }
                        fishingAreaProgress[area.id] = 0;
                        // Set new random interval between 30-45 seconds, affected by rod tier
                        fishingAreaNextCatch[area.id] = getFishingInterval();
                    }
                }
            });
        }, 100);

        // Save game every 5 seconds
        setInterval(() => {
            const gameState = {
                bells,
                totalBellsEarned,
                upgrades: upgrades.map(u => ({ id: u.id, owned: u.owned })),
                progress: upgradeProgress,
                fishingAreas: fishingAreas.map(a => ({ id: a.id, rods: a.rods })),
                fishingAreaProgress,
                fishingAreaNextCatch,
                inventory,
                caughtFish: Array.from(caughtFish), // Convert Set to Array for JSON
                donatedFish: Array.from(donatedFish), // Convert Set to Array for JSON
                purchasedVillagers,
                villagerCooldownEnd,
                fishingRodTier,
                villagerHouses,
                villagerAssignments
            };
            localStorage.setItem('animalCrossingBellsSave', JSON.stringify(gameState));
        }, 5000);

        // Load game
        function loadGame() {
            const saved = localStorage.getItem('animalCrossingBellsSave');
            if (saved) {
                const gameState = JSON.parse(saved);
                bells = gameState.bells || 0;
                totalBellsEarned = gameState.totalBellsEarned || 0;
                if (gameState.upgrades) {
                    gameState.upgrades.forEach(savedUpgrade => {
                        const upgrade = upgrades.find(u => u.id === savedUpgrade.id);
                        if (upgrade) {
                            upgrade.owned = savedUpgrade.owned;
                        }
                    });
                }
                if (gameState.progress) {
                    Object.assign(upgradeProgress, gameState.progress);
                }
                if (gameState.fishingAreas) {
                    gameState.fishingAreas.forEach(savedArea => {
                        const area = fishingAreas.find(a => a.id === savedArea.id);
                        if (area) {
                            area.rods = savedArea.rods;
                        }
                    });
                }
                if (gameState.inventory) {
                    Object.assign(inventory, gameState.inventory);
                }
                if (gameState.fishingAreaProgress) {
                    Object.assign(fishingAreaProgress, gameState.fishingAreaProgress);
                }
                if (gameState.fishingAreaNextCatch) {
                    Object.assign(fishingAreaNextCatch, gameState.fishingAreaNextCatch);
                }
                if (gameState.caughtFish) {
                    caughtFish = new Set(gameState.caughtFish); // Convert Array back to Set
                }
                if (gameState.purchasedVillagers) {
                    purchasedVillagers = gameState.purchasedVillagers;
                }
                if (gameState.villagerCooldownEnd) {
                    villagerCooldownEnd = gameState.villagerCooldownEnd;
                }
                if (gameState.donatedFish) {
                    donatedFish = new Set(gameState.donatedFish);
                }
                if (gameState.fishingRodTier) {
                    fishingRodTier = gameState.fishingRodTier;
                }
                if (gameState.storeStage !== undefined) {
                    storeStage = gameState.storeStage;
                }
                if (gameState.villagerHouses !== undefined) {
                    villagerHouses = gameState.villagerHouses;
                }
                if (gameState.villagerAssignments) {
                    villagerAssignments = gameState.villagerAssignments;
                }
                if (gameState.hasCompletedInitialSelection !== undefined) {
                    hasCompletedInitialSelection = gameState.hasCompletedInitialSelection;
                }
                if (gameState.villagerPoints) {
                    villagerPoints = gameState.villagerPoints;
                }
                if (gameState.rerollsRemaining !== undefined) {
                    rerollsRemaining = gameState.rerollsRemaining;
                }
            }
            calculateCPS();
        }

        // Save game
        function saveGame() {
            const gameState = {
                bells,
                totalBellsEarned,
                upgrades: upgrades.map(u => ({ id: u.id, owned: u.owned })),
                progress: upgradeProgress,
                fishingAreas: fishingAreas.map(a => ({ id: a.id, rods: a.rods })),
                fishingAreaProgress,
                fishingAreaNextCatch,
                inventory,
                caughtFish: Array.from(caughtFish),
                donatedFish: Array.from(donatedFish),
                purchasedVillagers,
                villagerCooldownEnd,
                fishingRodTier,
                storeStage,
                villagerHouses,
                villagerAssignments,
                hasCompletedInitialSelection,
                villagerPoints,
                rerollsRemaining
            };
            localStorage.setItem('animalCrossingBellsSave', JSON.stringify(gameState));
        }

        // Reset game
        function resetGame() {
            if (confirm('Are you sure you want to start over? This will delete all your progress!')) {
                localStorage.removeItem('animalCrossingBellsSave');
                // Force localStorage to flush by accessing it
                localStorage.getItem('animalCrossingBellsSave');
                // Use setTimeout to ensure localStorage is cleared before reload
                setTimeout(() => {
                    location.reload();
                }, 100);
            }
        }

        // Initialize game
        async function initGame() {
            try {
                console.log('üèùÔ∏è Initializing Island Idler...');
                initDOMElements();
                
                // Verify DOM elements loaded
                if (!shopContainer || !upgradesContainer) {
                    console.error('‚ùå DOM elements not found!', {
                        shopContainer,
                        upgradesContainer,
                        bellCountEl
                    });
                    return;
                }
                
                // Initialize with fallback data immediately
                initializeFallbackData();
                updateCalendar();
                loadGame();
                
                // Setup UI
                updateShopName();
                buildShopItems();
                createShopItems();
                createUpgradeButtons();
                updateDisplay();
                updateFishingAreasUI();
                initVillagersGrid();
                updateVillagersGrid();
                updateAssignedVillagers();
                updateMuseumDisplay();
                updateVillagerPointsUI();
                
                // Update museum when fish data loads
                setTimeout(() => updateMuseumDisplay(), 1000);
                
                // Update calendar every minute
                setInterval(updateCalendar, 60000);
                
                console.log('‚úÖ Game initialized successfully!');
                
                // Fetch API data and hide loading when done
                fetchAPIDataInBackground();
                
                // Trigger initial villager selection if not completed
                if (!hasCompletedInitialSelection && purchasedVillagers.length < 3) {
                    // Wait for villagers to load from API before showing selection
                    setTimeout(() => {
                        if (villagersCache.length > 0) {
                            console.log('üèùÔ∏è Starting initial villager selection...');
                            showVillagerSelection(true);
                        } else {
                            // Retry if villagers haven't loaded yet
                            setTimeout(() => {
                                if (villagersCache.length > 0) {
                                    showVillagerSelection(true);
                                }
                            }, 2000);
                        }
                    }, 1500);
                }
            } catch (error) {
                console.error('‚ùå Failed to initialize game:', error);
                updateLoadingStatus('Error loading game. Please refresh.');
            }
        }
        
        // Wait for DOM to be fully loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initGame);
        } else {
            // DOM is already ready, init immediately
            initGame();
        }
    </script>
</body>
</html>
